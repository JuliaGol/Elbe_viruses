---
title: "Viruses_basic_analysis"
author: "Julia Golebiowska"
date: "2024-08-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Viruses distribution analysis

In this Rmarkdown we are going to explore viral length, and metabolism and pathways distribution according to they niches and occurence.

```{r setup and loading}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(vegan)

setwd("C:/Users/jgolebiowska/Documents/IGB_phd/BICEST/virus/viral_abundances")
#load("~/IGB_phd/BICEST/virus/viral_abundances/viruses_basic_analysis.RData")
##lets load the viral data 
vir_genecluster_annot <- readRDS(file = "vir_genecluster_annot.RDS")
colnames(vir_genecluster_annot)[1] <- "gene"
#dereplication data
drep_clusters <- read.csv("Cdb.csv", header = TRUE, sep = ",")
drep_clusters[,"genome"] = sub(".fna", "", drep_clusters[,"genome"])
#hosts assignment  data - iphop
host_prediction_genome = read.csv("C:/Users/jgolebiowska/Documents/IGB_phd/BICEST/virus/viral_abundances/Host_prediction_to_genome_m90.csv")
host_prediction_genus = read.csv("C:/Users/jgolebiowska/Documents/IGB_phd/BICEST/virus/viral_abundances/Host_prediction_to_genus_m90.csv")
host_prediction_genome <- host_prediction_genome %>% 
  separate(Host.taxonomy, c("domain", "phylum", "class", "order", "family",  "genus", "species"), ";")
path = "C:/Users/jgolebiowska/Documents/IGB_phd/BICEST/virus/metadata/"
metadata <- read.csv(paste0(path,"PhysicochemicalParameters_mod3.csv"), header=TRUE, sep=",", row.names=1) 
#unify stromkilometer
metadata$Stromkilometer <- round(metadata$Stromkilometer)
metadata$Stromkilometer[which(metadata$Stromkilometer==715)] <- 712 
metadata$Stromkilometer[which(metadata$Stromkilometer==692)] <- 694 
metadata$Stromkilometer[which(metadata$Stromkilometer==666)] <- 665 
metadata$Stromkilometer[which(metadata$Stromkilometer==652)] <- 651
metadata$Stromkilometer <- as.factor(metadata$Stromkilometer)  
#salinity categories
metadata <- metadata %>% mutate(Salinity_level =  case_when(Salinity_PSU <= .5  ~ 'freshwater',  Salinity_PSU > .5 & Salinity_PSU <= 5.5  ~ 'oligohaline', Salinity_PSU > 5.5 & Salinity_PSU <= 18  ~ 'mesohaline', Salinity_PSU > 18  ~ 'polyhaline'))

drep_clusters_fin_taxonomy_unified <- readRDS(file ="C:/Users/jgolebiowska/Documents/IGB_phd/BICEST/virus/viral_abundances/CCA_marker_gene/drep_clusters_fin_taxonomy_unified.RDS")

geneabund_drep_marker_taxonomy_long <- readRDS(file ="C:/Users/jgolebiowska/Documents/IGB_phd/BICEST/virus/viral_abundances/CCA_marker_gene/geneabund_drep_marker_taxonomy_long.RDS")

Combined_quality_summary <- read.csv(file="C:/Users/jgolebiowska/Documents/IGB_phd/BICEST/virus/viral_abundances/Combined_quality_summary.tsv", sep="\t")


```

## 1. Length distribution analysis 

You can also embed plots, for example:

```{r statistic, echo=FALSE}

#METAG only 
Combined_quality_summary$contig_length <- as.numeric(Combined_quality_summary$contig_length)
Combined_quality_summary$completeness <- as.numeric(Combined_quality_summary$completeness)
Combined_quality_summary_METAG <- Combined_quality_summary %>% filter(grepl("METAG" , contig_id)) %>% 
  mutate(estimated_contig_length=(contig_length/completeness)*100)

#how many contigs
contigs_counts_METAG <- Combined_quality_summary_METAG %>% select("contig_id") %>% unique() %>% nrow()
#960924
contigs_counts_METAG_filtered <- Combined_quality_summary_METAG %>% filter(checkv_quality!="Low-quality" & checkv_quality!="Not-determined") %>% unique() %>% nrow()
#11496 

drep_clusters <-  Combined_quality_summary_METAG[,c("contig_id", "contig_length", "estimated_contig_length", "checkv_quality")] %>%  merge(drep_clusters, by.y="genome", by.x="contig_id") #%>% filter(checkv_quality!="Low-quality" & checkv_quality!="Not-determined")

drep_clusters <-  drep_clusters %>% mutate(AccessionNumber_TBDSven = str_extract(contig_id, "SAMEA[0-9]+"))
#add salinity categories
drep_clusters <- merge(drep_clusters, metadata[, c("AccessionNumber_TBDSven", "Sample_type", "Salinity_level")], all.x = T, all.y = F, by="AccessionNumber_TBDSven") 
drep_clusters$data_type <- rep(c("METAG"), each=nrow(drep_clusters))
drep_clusters[grep("METAT", drep_clusters$genome),"data_type"] <-"METAT"
drep_clusters$estimated_contig_length <- drep_clusters$estimated_contig_length/1000
tiff("hist_viral_contigs_length_METAG.tiff")
hist(drep_clusters$estimated_contig_length[which(drep_clusters$data_type=="METAG")], breaks=100, ylim=c(0,1500), xlim=c(0,400), main = "Good quality contigs length distribution", xlab = "Length [kb]", cex.axis=1, cex.lab=1.5, cex.main=1.5)
dev.off()
# tiff("hist_viral_contigs_length_METAT.tiff")
# hist(drep_clusters$estimated_contig_length[which(drep_clusters$data_type=="METAT")], breaks=100, ylim=c(0,100), xlim=c(0,50), main = "Good quality transcripts length distribution", xlab = "Length [kb]", cex.axis=1, cex.lab=1.5, cex.main=1.5)
# dev.off()
#make histograms for salinity categories
tiff("hist_viral_contigs_length_METAG_oligo.tiff")
hist(drep_clusters$estimated_contig_length[which(drep_clusters$data_type=="METAG" & drep_clusters$Salinity_level=="oligohaline")], breaks=100, ylim=c(0,2500), xlim=c(0,400), main = "Good quality contigs length distribution", xlab = "Length [kb]", cex.axis=1, cex.lab=1.5, cex.main=1.5)
dev.off()
tiff("hist_viral_contigs_length_METAG_meso.tiff")
hist(drep_clusters$estimated_contig_length[which(drep_clusters$data_type=="METAG" & drep_clusters$Salinity_level=="mesohaline")], breaks=100, ylim=c(0,1000), xlim=c(0,400), main = "Good quality contigs length distribution", xlab = "Length [kb]", cex.axis=1, cex.lab=1.5, cex.main=1.5)
dev.off()
tiff("hist_viral_contigs_length_METAG_poly.tiff")
hist(drep_clusters$estimated_contig_length[which(drep_clusters$data_type=="METAG" & drep_clusters$Salinity_level=="polyhaline")], breaks=100, ylim=c(0,500), xlim=c(0,400), main = "Good quality contigs length distribution", xlab = "Length [kb]", cex.axis=1, cex.lab=1.5, cex.main=1.5)
dev.off()
#lets visualise together 
drep_clusters$Salinity_level <- factor(drep_clusters$Salinity_level, level = c( "freshwater", "oligohaline",  "mesohaline", "polyhaline", NA))
capitalize <- function(string) {
  substr(string, 1, 1) <- toupper(substr(string, 1, 1))
  string
}
salinity_hist <- na.omit(drep_clusters) %>% ggplot()  + geom_histogram(aes(x=estimated_contig_length, y = ..density.., fill = Salinity_level), position = 'identity', bins = 100, na.rm = T, alpha=1) +
scale_fill_manual(values=c(brewer.pal(n = 4, name = "Blues")), breaks =  c("freshwater", "oligohaline",  "mesohaline", "polyhaline")) +  scale_colour_manual(values=c(brewer.pal(n = 4, name = "Blues")), breaks =  c("freshwater", "oligohaline",  "mesohaline", "polyhaline")) + scale_y_continuous(name="Relative Frequency", labels = scales::percent) + 
  scale_x_continuous(name="Length [kb]", breaks = seq(0, 100, 20), limits= c(0, 100)) + 
  geom_step(aes(x=estimated_contig_length, y = ..density.., fill = Salinity_level),
    stat = "bin", bins = 100,
    direction = "mid"
  ) + facet_grid(vars(Salinity_level), labeller = labeller(Salinity_level = capitalize)) + guides(fill="none") + theme_bw(base_size = 20)
saveRDS(salinity_hist, file="salinity_hist.RDS")
tiff("C:/Users/jgolebiowska/Documents/IGB_phd/BICEST/virus/viral_abundances/length_salinity_level.tiff")
salinity_hist
dev.off()
drep_clusters$Sample_type <- factor(drep_clusters$Sample_type, level = c("Light_fraction", "Heavy_fraction", "Free_living"))
fraction_hist <- na.omit(drep_clusters) %>% ggplot(aes(estimated_contig_length, fill = Sample_type, na.rm = TRUE)) + geom_histogram(position = 'identity', bins = 100, na.rm = T)
tiff("length_fraction_level.tiff")
fraction_hist
dev.off()
```

```{r}
#size distribution METAT
Combined_quality_summary_METAT <- Combined_quality_summary %>% filter(grepl("METAT" , contig_id)) %>% 
  mutate(estimated_contig_length=(contig_length/completeness)*100)

Combined_quality_summary_METAT$estimated_contig_length <- as.numeric(Combined_quality_summary_METAT$estimated_contig_length)
hist(Combined_quality_summary_METAT$estimated_contig_length, breaks=100)

```

## 2. Metabolism and pathways analysis
```{r plot metabolism}
#Prepare data
pathways <- read.csv("Combined_VIBRANT_AMG_pathways_GROS22_SAMEA.scaffolds.min0.tsv", sep='\t')
#put all different Glycosphingolipids biosynthesis into one category 
pathways[which(grepl("Glycosphingolipid", pathways$Pathway)), "Pathway"] <- "Glycosphingolipid biosynthesis"
#separate KO so we can use them as a key for merging to data frames remove redundant
#KO can belong to multiple pathways - we count them all
pathways <-  pathways %>% separate_rows(Present.AMG.KOs) %>% unique() 

#merge with pathways to include metabolism information related to found axuliary genes by vibrant - selecting auxiliary genes
#to save computations remove uneccessery columns
#remove gene - contig id - so be not popuplate genecluster counts
vir_genecluster_annot <- vir_genecluster_annot %>% select(-c("gene", "range", "DESCRIPTION", "mem",  "length", "pos")) %>% distinct() %>% merge(pathways[,c("Metabolism", "Pathway", "Present.AMG.KOs")], by.x="KO", by.y="Present.AMG.KOs") # find more pathways 

#but first unify genome names
vir_genecluster_annot <- vir_genecluster_annot %>% group_by(Metabolism, Pathway) %>% summarise(across(where(is.numeric), sum))

vir_genecluster_annot <- vir_genecluster_annot  %>% ungroup() %>% unique()
#change zero to NA to reduce calculations (less rows in resulting long table)
vir_genecluster_annot[vir_genecluster_annot==0] <- NA
#format for plotting
vir_genecluster_annot <-  vir_genecluster_annot %>% pivot_longer(cols=colnames(vir_genecluster_annot)[which(grepl("GROS", colnames(vir_genecluster_annot)))], names_to = "sampleid", values_to = "counts", values_drop_na = T) # %>% unique()
#add metadata
vir_genecluster_annot <-  vir_genecluster_annot %>% merge(metadata[, c("Station", "StationNumber", "Stromkilometer", "Sample_type", "Sample_date", "Salinity_PSU", "sampleid", "AccessionNumber_TBDSven", "data_type", "Salinity_level")], by="sampleid")
vir_genecluster_annot$Sample_date <- factor(vir_genecluster_annot$Sample_date, levels= c("May-21", "Jul-21", "Feb-22", "Jun-22",  "May-22", "Nov-22"))
saveRDS(vir_genecluster_annot, file="vir_genecluster_annot_pathways.RData")
#saveRDS(vibrant_genecluster_abund, file ="vibrant_genecluster_abund.RDS")
#save.image("viruses_basic_analysis.RData")
```

```{r}
#visualizations

#sampling date
pathways_date_plot <- vir_genecluster_annot %>%  ggplot() + geom_bar(position ="fill", stat = "identity", aes(x=sampleid, y=counts, fill = Pathway)) + facet_wrap(~data_type *Sample_date, scales= "free_x") + scale_y_continuous(labels=scales::percent_format()) + scale_x_discrete(labels = NULL, breaks = NULL) + ggtitle("Relative abundace of pathways across different fractions") + ylab("Relative abundace") + theme(axis.title.y = element_text(angle=90, size=12), legend.text = element_text(size=10)) + theme_bw(base_size=20)
tiff("Pathways_fractions_plot.tiff", unit="cm", height=29.7, width=21.0, res =300)
pathways_date_plot
dev.off()
pdf("Pathways_fractions_plot.pdf", height=29.7, width=21.0)
pathways_date_plot
dev.off()
metabolism_date_plot <- vir_genecluster_annot %>%  ggplot() + geom_bar(position ="fill", stat = "identity", aes(x=reorder(sampleid, StationNumber), y=counts, fill = Metabolism)) + facet_wrap(~data_type *Sample_date, scales= "free_x") + scale_y_continuous(labels=scales::percent_format()) + scale_x_discrete(labels = vir_genecluster_annot$Stromkilometer) + ggtitle("Relative abundace of pathways across different fractions") + ylab("Relative abundace") + theme(axis.title.y = element_text(angle=90, size=12), axis.text.x = element_text(angle = 90, hjust = 1))   + theme_bw(base_size=20)   
#salinity level metabolism
tiff("Metabolism_date_plot.tiff", unit="cm", height=29.7, width=21.0, res =300)
metabolism_date_plot
dev.off()
pdf("Metabolism_date_plot.pdf", height=29.7, width=21.0)
metabolism_date_plot
dev.off()
vir_genecluster_annot$Salinity_level <- factor(vir_genecluster_annot$Salinity_level, level = c( "freshwater", "oligohaline",  "mesohaline", "polyhaline"))

metabolism_Salinity_level_plot <- vir_genecluster_annot %>%  ggplot() + geom_bar(position ="fill", stat = "identity", aes(x=Salinity_level, y=counts, fill = Metabolism)) + facet_wrap(~data_type *Sample_date, scales= "free_x") + scale_y_continuous(labels=scales::percent_format()) + ggtitle("Relative abundace of matabolism across different fractions") + ylab("Relative abundance") + xlab("Salinity")  + theme_bw(base_size=20)  + theme(axis.text.x = element_text(angle = 45, hjust = 1))  #hard to interpret - big variability - check
#stations more variability in metat 


#check after removing duplicated rows (the same cluster multiple contigs)
metabolism_Station_plot <-  vir_genecluster_annot %>% distinct()  %>%  ggplot() + geom_bar(position ="fill", stat = "identity", aes(x=as.factor(Stromkilometer), y=counts, fill = Metabolism)) + facet_wrap(~data_type *Sample_date, scales= "free_x") + scale_y_continuous(labels=scales::percent_format()) + scale_y_continuous(labels=scales::percent_format()) + ylab("Relative abundace") + theme(axis.title.y = element_text(angle=90, size=12)) + xlab("Elbe km") + theme_bw(base_size=20)

tiff("metabolism_station_plot.tiff", unit="px", width = 1000, height = 1000)
metabolism_Station_plot
dev.off()

palette_66_contrast <- c(
  "#1b9e77", "#e41a1c", "#1f78b4", "#fdb462", "#984ea3", "#66a61e",
  "#fb8072", "#7570b3", "#e6ab02", "#a6d854", "#d95f02", "#80b1d3",
  "#e7298a", "#33a02c", "#beaed4", "#ff7f00", "#7fc97f", "#b3de69",
  "#3288bd", "#f46d43", "#8dd3c7", "#bc80bd", "#4daf4a", "#fdae61",
  "#41ae76", "#cab2d6", "#e31a1c", "#91bfdb", "#d9f0a3", "#810f7c",
  "#74add1", "#fee08b", "#5ab4ac", "#f16913", "#bcbddc", "#54278f",
  "#a6761d", "#b8e186", "#2171b5", "#ccebc5", "#f46d43", "#8c6bb1",
  "#d9d9d9", "#fec44f", "#6baed6", "#9ecae1", "#ffed6f", "#08306b",
  "#9e9ac8", "#6a51a3", "#969696", "#fdae6b", "#8c510a", "#cccccc",
  "#bdbdbd", "#636363", "#31a354", "#c994c7", "#d8b365", "#f5f5f5",
  "#abdda4", "#fc8d59", "#3288bd", "#fee090", "#4575b4", "#e0f3f8"
)


vir_genecluster_annot_pathway <- vir_genecluster_annot %>% group_by(Stromkilometer, Sample_date, data_type) %>% mutate(total = sum(counts)) %>% mutate(Percentage = counts / total * 100) %>% group_by(Stromkilometer, Sample_date, data_type, Metabolism, Pathway) %>% mutate(total_Percentage = sum(Percentage)) %>% select(Stromkilometer, Sample_date, data_type, Metabolism,  Pathway, total_Percentage)  %>%  distinct() %>% mutate(Pathway =  case_when(total_Percentage <= 0.5 ~  "Other", TRUE ~ Pathway )) 

pathway_Station_plot <-  vir_genecluster_annot_pathway %>% ggplot(aes(x=Stromkilometer, y = total_Percentage, fill = Pathway)) + geom_bar(stat='identity',  position = "fill") + facet_wrap(~data_type * factor(Sample_date), scales= "free_x") + scale_y_continuous(labels=scales::percent_format()) + theme_bw(base_size=18) + theme(axis.title.y = element_text(angle=90), legend.text = element_text(size=10)) + xlab("Elbe km") + ylab("Relative abundance") + scale_fill_manual(values = rep(palette_66_contrast,3)) + guides(fill=guide_legend(ncol=1)) 

tiff("pathway_station_plot.tiff", unit="px", width = 1010, height = 1000)
pathway_Station_plot
dev.off()

vir_genecluster_annot_pathway_salinity_level <- vir_genecluster_annot %>% group_by(Stromkilometer, Salinity_level, Sample_date, data_type) %>% mutate(total = sum(counts)) %>% mutate(Percentage = counts / total * 100) %>% group_by(Stromkilometer, Salinity_level, Sample_date, data_type, Metabolism, Pathway) %>% mutate(total_Percentage = sum(Percentage)) %>% select(Stromkilometer, Salinity_level, Sample_date, data_type, Metabolism,  Pathway, total_Percentage)  %>%  distinct() %>% mutate(Pathway =  case_when(total_Percentage <= 1 ~  "Other", TRUE ~ Pathway )) 
#order
vir_genecluster_annot_pathway_salinity_level$Salinity_level <- factor(vir_genecluster_annot_pathway_salinity_level$Salinity_level, level = c( "freshwater", "oligohaline",  "mesohaline", "polyhaline"))

vir_genecluster_annot_pathway_salinity_level$sample_spatio_temp <- paste(factor(vir_genecluster_annot_pathway_salinity_level$Sample_date), vir_genecluster_annot_pathway_salinity_level$Stromkilometer, sep=" " )

vir_genecluster_annot_pathway_salinity_level$sample_spatio_temp <-factor(vir_genecluster_annot_pathway_salinity_level$sample_spatio_temp, levels=c("May-21 608", "May-21 633", "May-21 651", "May-21 665", "May-21 694", "May-21 712","Jul-21 633", "Jul-21 651", "Jul-21 665", "Jul-21 694", "Jul-21 712", "Feb-22 633", "Feb-22 651", "Feb-22 665", "Feb-22 694", "Feb-22 712", "May-22 633", "May-22 651", "May-22 665", "May-22 694", "May-22 712", "Jun-22 633", "Jun-22 651", "Jun-22 665", "Jun-22 694", "Jun-22 712", "Nov-22 633", "Nov-22 651", "Nov-22 665", "Nov-22 694", "Nov-22 712"))

found_pathways<-sort(unique(vir_genecluster_annot_pathway_salinity_level$Pathway))

#pathways order in the legend 
vir_genecluster_annot_pathway_salinity_level$Pathway <- factor(vir_genecluster_annot_pathway_salinity_level$Pathway, levels= c(found_pathways[which(found_pathways!="Other")], "Other")) 

pathway_salinity_plot <-  vir_genecluster_annot_pathway_salinity_level %>% ggplot(aes(x=Salinity_level, y = total_Percentage, fill = Pathway)) + geom_bar(stat='identity',  position = "fill") + facet_wrap(~data_type, scales= "free_x") + scale_y_continuous(labels=scales::percent_format()) + theme_bw(base_size=18) + theme(axis.title.y = element_text(angle=90), legend.text = element_text(size=10)) + xlab("Elbe km") + ylab("Relative abundance") + scale_fill_manual(values = palette_66_contrast) + scale_x_discrete() + guides(fill=guide_legend(ncol=1)) 

tiff("pathway_salinity_plot.tiff", unit="px", width = 1010, height = 1000)
pathway_salinity_plot
dev.off()
#per salinity
library(ggh4x)
library(ggthemes)

pathway_salinity_plot <-  vir_genecluster_annot_pathway_salinity_level %>% ggplot(aes(x=sample_spatio_temp, y = total_Percentage, fill = Pathway)) + geom_bar(stat='identity',  position = "fill") + scale_y_continuous(labels=scales::percent_format())  + xlab("Elbe km") + ylab("Relative abundance") + scale_fill_manual(values = palette_66_contrast) + facet_grid2(data_type ~ Salinity_level, render_empty=F, scales="free", space="free" ) + theme_clean(base_size=18) + theme(axis.title.y = element_text(angle=90), axis.text.x = element_text(angle=90), strip.text.x = element_text(size = 13), legend.position = "bottom", legend.background = element_rect(color = NA),  legend.key.size =  unit(0.5, "cm"))  + scale_x_discrete(name ="Sample") + guides(fill=guide_legend(title.position = "top", ncol=4))

tiff("pathway_salinity_plot.tiff", unit="cm", width=2*29.7, height=2*21.0, res =300)
pathway_salinity_plot
dev.off()
pdf("pathway_salinity_plot.pdf", width=29.7, height=21.0)
pathway_salinity_plot
dev.off()

metabolism_salinity_plot <-  vir_genecluster_annot_pathway_salinity_level %>% ggplot(aes(x=sample_spatio_temp, y = total_Percentage, fill = Metabolism)) + geom_bar(stat='identity',  position = "fill") + scale_y_continuous(labels=scales::percent_format())  + xlab("Elbe km") + ylab("Relative abundance") + scale_fill_manual(values = palette_66_contrast)+ facet_grid2(data_type ~ Salinity_level, render_empty=F, scales="free", independent = "x") + theme_clean(base_size=18) + theme(axis.title.y = element_text(angle=90), axis.text.x = element_text(angle=90), strip.text.x = element_text(size = 15), legend.position = "bottom", legend.background = element_rect(color = NA),  legend.key.size =  unit(0.5, "cm"))  + scale_x_discrete(name ="Sample") + guides(fill=guide_legend(title.position = "top", ncol=4)) + scale_fill_manual(values = palette_66_contrast)  

tiff("metabolism_salinity_plot.tiff", unit="cm", width=2*29.7, height=2*21.0, res =300)
metabolism_salinity_plot
dev.off()
pdf("metabolism_salinity_plot.pdf", width=29.7, height=21.0)
metabolism_salinity_plot
dev.off()
#fractions
vir_genecluster_annot_pathway_fractions <- vir_genecluster_annot %>% group_by(Stromkilometer, Sample_type, Sample_date, data_type) %>% mutate(total = sum(counts)) %>% mutate(Percentage = counts / total * 100) %>% group_by(Stromkilometer, Sample_type, Sample_date, data_type, Metabolism, Pathway) %>% mutate(total_Percentage = sum(Percentage)) %>% select(Stromkilometer, Sample_type, Sample_date, data_type, Metabolism,  Pathway, total_Percentage)  %>%  distinct() %>% mutate(Pathway =  case_when(total_Percentage <= 1 ~  "Other", TRUE ~ Pathway )) 
#order
vir_genecluster_annot_pathway_fractions$Sample_type <- factor(vir_genecluster_annot_pathway_fractions$Sample_type, level = c( "Free_living", "Light_fraction",  "Heavy_fraction"))

vir_genecluster_annot_pathway_fractions$sample_spatio_temp <- paste(factor(vir_genecluster_annot_pathway_fractions$Sample_date), vir_genecluster_annot_pathway_fractions$Stromkilometer, sep=" " )

vir_genecluster_annot_pathway_fractions$sample_spatio_temp <-factor(vir_genecluster_annot_pathway_fractions$sample_spatio_temp, levels=c("May-21 608", "May-21 633", "May-21 651", "May-21 665", "May-21 694", "May-21 712","Jul-21 633", "Jul-21 651", "Jul-21 665", "Jul-21 694", "Jul-21 712", "Feb-22 633", "Feb-22 651", "Feb-22 665", "Feb-22 694", "Feb-22 712", "May-22 633", "May-22 651", "May-22 665", "May-22 694", "May-22 712", "Jun-22 633", "Jun-22 651", "Jun-22 665", "Jun-22 694", "Jun-22 712", "Nov-22 633", "Nov-22 651", "Nov-22 665", "Nov-22 694", "Nov-22 712"))

found_pathways<-sort(unique(vir_genecluster_annot_pathway_fractions$Pathway))

#pathways order in the legend 
vir_genecluster_annot_pathway_fractions$Pathway <- factor(vir_genecluster_annot_pathway_fractions$Pathway, levels= c(found_pathways[which(found_pathways!="Other")], "Other")) 


new_labels <- c("Light_fraction" = "Suspended particles", "Heavy_fraction" = "Sinking particles", "Free_living" = "Free-living", "METAT" = "METAT", "METAG" = "METAG")

pathways_fractions_plot <- vir_genecluster_annot_pathway_fractions %>%  ggplot() + geom_bar(position ="fill", stat = "identity", aes(x=sample_spatio_temp, y=total_Percentage, fill = Pathway)) + facet_wrap(~data_type *Sample_type, scales= "free_x", labeller = as_labeller(new_labels)) + scale_y_continuous(labels=scales::percent_format()) + scale_x_discrete(labels = NULL, breaks = NULL)  + 
  # ggtitle("Relative abundace of pathways across different fractions")  + 
  ylab("Relative abundace") + xlab("") + 
  ylab("Relative abundace") + xlab("") +   theme(legend.key=element_blank(), 
  axis.text.x = element_text(colour = "black", size = 12, face = "bold", angle = 90, vjust = 0.3, hjust = 1), 
  axis.text.y = element_text(colour = "black", face = "bold", size = 11), 
  legend.text = element_text(size = 10, face ="bold", colour ="black"), 
  legend.title = element_text(size = 12, face = "bold"), strip.text.x = element_text(size = 10),
  panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),  legend.position = "bottom") +  theme_bw(base_size=20) + theme(legend.position='bottom') + guides(fill=guide_legend(title.position = "top", ncol=3))
tiff("Pathways_fractions_plot.tiff", unit="cm", height=45, width=40, res =300)
pathways_fractions_plot 
dev.off()
Metabolism_fractions_plot <- vir_genecluster_annot_pathway_fractions %>%  ggplot() + geom_bar(position ="fill", stat = "identity", aes(x=sample_spatio_temp, y=total_Percentage, fill = Metabolism)) + facet_wrap(~data_type *Sample_type, scales= "free_x",labeller = as_labeller(new_labels)) + scale_y_continuous(labels=scales::percent_format()) + scale_x_discrete(labels = NULL, breaks = NULL)  + 
  # ggtitle("Relative abundance of metabolism across different fractions")  +
  ylab("Relative abundace") + xlab("") +   theme(legend.key=element_blank(), 
  axis.text.x = element_text(colour = "black", size = 12, face = "bold", angle = 90, vjust = 0.3, hjust = 1), 
  axis.text.y = element_text(colour = "black", face = "bold", size = 11), 
  legend.text = element_text(size = 10, face ="bold", colour ="black"), 
  legend.title = element_text(size = 12, face = "bold"), strip.text.x = element_text(size = 10),
  panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),  legend.position = "bottom") +  theme_bw(base_size=20) + theme(legend.position='bottom') + guides(fill=guide_legend(title.position = "top", ncol=3))
tiff("Metabolism_fractions_plot.tiff", unit="cm", height=45, width=40, res =300)
Metabolism_fractions_plot 
dev.off()
```
```{r}

#bubble plot version
xx =  vir_genecluster_annot_pathway_salinity_level %>% ggplot(aes(x = sample_spatio_temp, y=as.factor(Pathway))) + 
  geom_point(aes(size = total_Percentage, color=Pathway), alpha = 0.75) +   #scale_y_discrete(limits = rev(levels(vir_genecluster_annot_pathway_salinity_level$Pathway))) +
  scale_size_continuous(limits = c(0.000001, 100), breaks = c(1,10,50,75))+ facet_grid2(data_type ~ Salinity_level, render_empty=F, scales="free", space = "free", drop=T) + 
  labs( x= "", y = "", size = "Relative Abundance (%)", color = "class") +  
 # scale_fill_manual(values = colours, guide = FALSE) + 

  theme_clean(base_size=15)  + 
  theme(legend.key=element_blank(), 
  axis.text.x = element_text(colour = "black", size = 12, face = "bold", angle = 90, vjust = 0.3, hjust = 1), 
  axis.text.y = element_text(colour = "black", face = "bold", size = 11), 
  legend.text = element_text(size = 10, face ="bold", colour ="black"), 
  legend.title = element_text(size = 12, face = "bold"), strip.text.x = element_text(size = 10),
  panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),  legend.position = "bottom") + guides(color = "none")
tiff("pathway_salinity_level_bubble_plot.tiff", unit="cm", height=35, width=60, res =300)
xx
dev.off()
pdf("pathway_salinity_level_bubble_plot.pdf", height=21.0, width=29.7)
xx
dev.off()
```


```{r}
#bubble plot version
xx =  vir_genecluster_annot_pathway_salinity_level %>% ggplot(aes(x = sample_spatio_temp, y=as.factor(Pathway))) + 
  geom_point(aes(size = total_Percentage, color=Pathway), alpha = 0.75) +   #scale_y_discrete(limits = rev(levels(vir_genecluster_annot_pathway_salinity_level$Pathway))) +
  scale_size_continuous(limits = c(0.000001, 100), breaks = c(1,10,50,75)) + facet_grid2(data_type ~ Salinity_level, render_empty=F, scales="free", space = "free", drop=T) + 
  labs( x= "", y = "", size = "Relative Abundance (%)", color = "class") +
 # scale_fill_manual(values = colours, guide = FALSE) + 
  theme_clean(base_size=15)  + 
  theme(legend.key=element_blank(), 
  axis.text.x = element_text(colour = "black", size = 12, face = "bold", angle = 90, vjust = 0.3, hjust = 1), 
  axis.text.y = element_text(colour = "black", face = "bold", size = 11), 
  legend.text = element_text(size = 10, face ="bold", colour ="black"), 
  legend.title = element_text(size = 12, face = "bold"), strip.text.x = element_text(size = 10),
  panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),  legend.position = "bottom") + guides(color = "none") + scale_size(range = c(0, 15))  
tiff("pathway_salinity_level_bubble_plot_scaled.tiff", unit="cm", height=35, width=60, res =300)
xx
dev.off()
pdf("pathway_salinity_level_bubble_plot_scales.pdf", height=21.0, width=29.7)
xx
dev.off()
```


```{r}
#bubble plot version
mm =  vir_genecluster_annot_pathway_salinity_level %>% ggplot(aes(x = sample_spatio_temp, y=as.factor(Metabolism))) + 
  geom_point(aes(size = total_Percentage, color=Metabolism), alpha = 0.75) + 
  scale_size_continuous(limits = c(0.000001, 100), breaks = c(1,10,50,75))+ facet_grid2(data_type ~ Salinity_level, render_empty=F, scales="free", space = "free", drop=T) + 
  labs( x= "", y = "", size = "Relative Abundance (%)", color = "class") +  
 # scale_fill_manual(values = colours, guide = FALSE) + 
  scale_y_discrete(limits = rev(levels(vir_genecluster_annot_pathway_salinity_level$Metabolism))) +
  theme_clean(base_size=15)  + 
  theme(legend.key=element_blank(), 
  axis.text.x = element_text(colour = "black", size = 12, face = "bold", angle = 90, vjust = 0.3, hjust = 1), 
  axis.text.y = element_text(colour = "black", face = "bold", size = 11), 
  legend.text = element_text(size = 10, face ="bold", colour ="black"), 
  legend.title = element_text(size = 12, face = "bold"), strip.text.x = element_text(size = 10),
  panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),  legend.position = "bottom") + guides(color = "none")  + scale_size(range = c(0, 15))
tiff("metabolism_salinity_level_bubble_plot_scaled.tiff", unit="cm", height=35, width=60, res =300)
mm
dev.off()
pdf("metabolism_salinity_level_bubble_plot_scaled.pdf", height=21.0, width=29.7)
mm
dev.off()
```

#3. Hosts analysis specialist and generalist
```{r , echo=FALSE}
#check hosts 
drep_clusters <- merge(drep_clusters, host_prediction_genome, by.x ="contig_id", by.y = "Virus", all.x = T, all.y = F)
drep_clusters_hosts_sum <-aggregate(phylum ~ primary_cluster , data = drep_clusters, FUN = function(x) length(unique(x)))
# Sort the pirates dataframe by height in decreasing order
drep_clusters_hosts_sum <- drep_clusters_hosts_sum[order(drep_clusters_hosts_sum$phylum, decreasing = TRUE),]
sum(drep_clusters_hosts_sum$phylum > 1 ) #126 clusters with host of multiple phylum - generalists
sum(drep_clusters_hosts_sum$phylum == 1 ) #558
length(unique(drep_clusters$primary_cluster)) - nrow(drep_clusters_hosts_sum) #1688

#no associated host
drep_sec_clusters_hosts_sum <-aggregate(phylum ~ secondary_cluster , data = drep_clusters, FUN = function(x) length(unique(x)))
# Sort the pirates dataframe by height in decreasing order
drep_sec_clusters_hosts_sum <- drep_sec_clusters_hosts_sum[order(drep_sec_clusters_hosts_sum$phylum, decreasing = TRUE),]
length(unique(drep_clusters$secondary_cluster)) - nrow(drep_sec_clusters_hosts_sum) #1720
drep_sec_clusters_hosts_sum <-aggregate(phylum ~ secondary_cluster , data = drep_clusters, FUN = function(x) length(unique(x)))
#more then one host - generalists
sum(drep_sec_clusters_hosts_sum$phylum > 1 ) #126
sum(drep_sec_clusters_hosts_sum$phylum == 1 ) #570
#no associated host
length(unique(drep_clusters$secondary_cluster)) - nrow(drep_sec_clusters_hosts_sum) #1720
```


##4. Isoelectric point
```{r}
IP <- read.csv("Isolectric_proteom.csv", row.names = 1)
#separate header column into multiple informative columns
IP <- IP %>%  separate_wider_delim(header,"\t", names=c("genome", "range", "no", "VOG", "protein name")) %>% select(c("genome", "VOG", "IP"))  %>% unique()
#edit genome to marge with drep cluster
#colnames(IP) <- c("x", "genome", "IP")
IP$genome <- gsub("_[1-9]$", "", IP$genome)
IP_drep <- IP %>% unique() %>% merge(drep_clusters, by.x="genome", by.y="contig_id")
IP_drep <- merge(IP_drep, drep_clusters_fin_taxonomy_unified)
IP_oligo <- IP_drep$IP[which(IP_drep$Salinity_niche=="oligohaline")]
IP_fresh <- IP_drep$IP[which(IP_drep$Salinity_niche=="freshwater")]
IP_meso <- IP_drep$IP[which(IP_drep$Salinity_niche=="mesohaline")]
IP_poly <- IP_drep$IP[which(IP_drep$Salinity_niche=="polyhaline")]

MCP_list <- c("PF03864.15", "PF04451.12", "PF05125.12", "VOG00633", "VOG01437", "VOG06289", "VOG06316", "VOG10260", "VOG10754")
#look for major capsid proteins these are false
IP_drep_MCP <- IP_drep %>% filter(VOG %in% MCP_list)
IP_oligo <- IP_drep_MCP$IP[which(IP_drep_MCP$Salinity_niche=="oligohaline")]
IP_fresh <- IP_drep_MCP$IP[which(IP_drep_MCP$Salinity_niche=="freshwater")]
IP_meso <- IP_drep_MCP$IP[which(IP_drep_MCP$Salinity_niche=="mesohaline")]
IP_poly <- IP_drep_MCP$IP[which(IP_drep_MCP$Salinity_niche=="polyhaline")]


IP_FL <- IP_drep$IP[which(IP_drep_MCP$Fraction_niche=="Free_living")]
IP_HF <- IP_drep$IP[which(IP_drep_MCP$Fraction_niche=="Heavy_fraction")]
IP_LF <- IP_drep$IP[which(IP_drep_MCP$Fraction_niche=="Light_fraction")]
```

```{r}
colors <- c("black", c(brewer.pal(n = 4, name = "Blues")[2:4]))
IP_hist_MCP <-IP_drep_MCP %>% filter(Salinity_niche %in% c("freshwater", "oligohaline", "mesohaline", "polyhaline")) %>% ggplot(aes(x=IP, y = ..density.., color =Salinity_niche))  + #geom_histogram(bin=30, na.rm = T,  alpha=0.5, color=NA,  aes(fill =Salinity_niche))  + 
  scale_x_continuous(name="Isoelectric point [pH]")  + scale_y_continuous(name="Relative Frequency", labels = scales::percent_format(scale = 1)) + scale_color_manual(values=colors, name = "Salinity niche") + #scale_fill_manual(values=c(brewer.pal(n = 4, name = "Blues")))  + 
 geom_density(size =1, adjust = 0.6, show.legend = FALSE) + ggtitle("Major Capsid Proteins") + theme_bw(base_size = 18) + 
  theme(plot.title = element_text(hjust = 0.5))#+ facet_wrap(~Salinity_niche)
saveRDS(IP_hist_MCP, file="IP_hist_MCP.rds")
tiff("Pi_hist_MCPs.tiff", unit="px")
IP_hist_MCP
dev.off()
```

```{r}

IP_hist_all <-IP_drep %>% filter(Salinity_niche %in% c("freshwater", "oligohaline", "mesohaline", "polyhaline")) %>% ggplot(aes(x=IP, y = ..density.., color =Salinity_niche)) + 
  scale_x_continuous(name="Isoelectric point [pH]")  + scale_y_continuous(name="Relative Frequency", labels = scales::percent) + scale_color_manual(values=colors, name = "Salinity niche") + geom_density(size =1, adjust = 0.3) + theme_bw(base_size = 18) + ggtitle("Viral proteome") + 
  theme(plot.title = element_text(hjust = 0.5))
saveRDS(IP_hist_all, file="IP_hist_all.rds")
tiff("Pi_hist.tiff")
IP_hist_all
dev.off()
```

```{r}
library(cowplot)
#fractions

IP_hist_frac <-IP_drep %>% filter(Fraction_niche %in% c("Free_living", "Light_fraction", "Heavy_fraction")) %>% ggplot(aes(x=IP, y = ..density.., color =Fraction_niche)) + 
  scale_x_continuous(name="Isoelectric point [pH]")  + scale_y_continuous(name="Relative Frequency", labels = scales::percent)  + geom_density(size =1, adjust = 0.3) + theme_dark(base_size = 18)
IP_hist_frac
```

```{r}
library(cowplot)
tiff("Pi_hist_plot_grid.tiff", width = 800, height = 400)
plot_grid( IP_hist_MCP, IP_hist_all, labels = c('A', 'B'), rel_widths = c(1,2))
dev.off()
svg("Pi_hist_plot_grid.svg", width = 10, height = 5)
plot_grid( IP_hist_MCP, IP_hist_all, labels = c('A', 'B'), rel_widths = c(1,2))
dev.off()
pdf("Pi_hist_plot_grid.pdf", width = 10, height = 5)
plot_grid( IP_hist_MCP, IP_hist_all, labels = c('A', 'B'), rel_widths = c(1,2))
dev.off()
```

