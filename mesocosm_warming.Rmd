---
title: "Mesocosm warming experiment"
author: "Julia Golebiowska"
date: "2025-08-08"
output: pdf_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=T, warning=F}
library("phyloseq")
library("ggplot2") 
library("cowplot")
library("dplyr")
library("vegan")
library("tidyr")
library("ape")

setwd("C:/Users/jgolebiowska/Documents/IGB_phd/BICEST/mesocosm_warming")
```

## Setting up

Import otu table, tree, weighted unifrac distance matrix calculated by qiime2 and metadata

```{r pressure, echo=FALSE}
setwd("C:/Users/jgolebiowska/Documents/IGB_phd/BICEST/mesocosm_warming")
count_tab <- read.table("feature-table-rare.tsv", header=T,
                        check.names=F, sep="\t", row.names = 1)
sample <- read.table("metadata.txt", header=T,
                     check.names=F, sep="\t", row.names = 1)
#change the data to get better legend 
# sample$`temperature elevation`[which(sample$`temperature elevation`=="0")] <- "tank delta 0"
# sample$`temperature elevation`[which(sample$`temperature elevation`=="2")] <- "tank delta 2"
# sample$`temperature elevation`[which(sample$`temperature elevation`=="4")] <- "tank delta 4"
sample$source <- sample$`temperature elevation`
sample$source[which(sample$`temperature elevation`=="-")] <- "field"
sample$source[which(sample$`temperature elevation`=="0")] <- "tank delta 0"
sample$source[which(sample$`temperature elevation`=="2")] <- "tank delta 2"
sample$source[which(sample$`temperature elevation`=="4")] <- "tank delta 4"
sample$source <- as.factor(sample$source)
sample$`temperature elevation`[which(sample$`temperature elevation`=="-")] <- 0
sample$`temperature elevation` <- as.numeric(sample$`temperature elevation`)
#remove row 78 - the sample is missed
sample <- sample[which(sample$`sample nr`!=78),] 
colnames(sample) <- c("sample_nr", "sampling_date", "sampling_site", "fraction", "tank_or_field", 
                      "replicate", "type", "DNA_or_RNA", "DNA_RNA_label","`temperature elevation`", "source")
#export distance matrix from qime2
weighted_unifrac_distance_matrix <- read.table("weighted_unifrac_distance_matrix.tsv", header=T,
                                               check.names=F, sep="\t", row.names = 1)

# dist.unifrac(abund, tree, weighted = FALSE, normalise = TRUE, num_threads = 1L)

weighted_unifrac_dist <- as.dist(weighted_unifrac_distance_matrix) 
taxa <- row.names(count_tab)
otu <- count_tab#[,5:length(count_tab[1,])]
treefile <- read.tree("C:/Users/jgolebiowska/Documents/IGB_phd/BICEST/tree.nwk")
```

# 1.DNA samples analysis

```{r}
#DNA
sample_DNA <- sample[which(sample$DNA_RNA_label == "D"),]
DNA_samples_names <- row.names(sample_DNA)
otu_DNA <- otu[, which(colnames(otu) %in% DNA_samples_names)]
sum_vec <- as.vector(apply(otu_DNA, 1, sum))
otu_DNA.nonzero <- otu_DNA[which(sum_vec!=0),]
otu_DNA.nonzero <- as.matrix(otu_DNA.nonzero)
taxa_DNA.nonzero <- taxa[which(sum_vec!=0)]
taxa_DNA.nonzero <- as.matrix(taxa_DNA.nonzero)
DNAcol <- which(colnames(weighted_unifrac_distance_matrix) %in% DNA_samples_names)
DNArow <- which(rownames(weighted_unifrac_distance_matrix) %in% DNA_samples_names)

weighted_unifrac_dist_DNA <- as.dist(weighted_unifrac_distance_matrix[DNArow, DNAcol]) 

row.names(taxa_DNA.nonzero) <- taxa_DNA.nonzero[,1]
ps_DNA <- phyloseq(otu_table(otu_DNA.nonzero, taxa_are_rows=TRUE), 
                   sample_data(sample_DNA), 
                   tax_table(taxa_DNA.nonzero))

#try unifrac
ord.pcoa.weighted_unifrac_dist <- ordinate(ps_DNA, method="PCoA", distance=weighted_unifrac_dist_DNA, na.rm = T)
p<-plot_ordination(ps_DNA, ord.pcoa.weighted_unifrac_dist, color="tank_or_field")
p$data$all <- paste(p$data$sampling_date, p$data$source, p$data$fraction) 
ggplot(data=p$data, aes(x=Axis.1, y=Axis.2, label=sample_nr, color= p$data$all, shape = fraction, )) + geom_point(size= 3) + geom_text(hjust=0, vjust=0) + labs(x="PC1", y= "PC2")
```

On this plot we can see an overview of DNA samples We can notice that 110 is an outlier so it can be removed from further analysis.
We can also notice that PA samples change more overtime then FL samples.
For FL samples the one coming from delta 2 degrees are the most similar with changing time.
The different conditions cluster separately but clustering is not definite.
FL samples: 88 and 82 from 1A and 98 from 1C are separated from other delta 0 samples - check when they were filtered - first run of filtration?.
For FL samples the distances between different conditions increases according to delta values.
The distance between field samples and experimental samples increases over time.
For FL samples from first run they are the closest and even surrounded by samples from delta 0.
The data suggest shift of community over time with more drastic differences in PA fraction for first run of the experiment.

## 1.1 Comparison of samples from first run of the experiment

```{r  first run only}

#remove 110 - outlier 
DNA_samples_names_1run <- DNA_samples_names[which(DNA_samples_names!="JG_110D" & (sample$sampling_date == "29/07/2024"  | sample$sampling_date == "31/07/2024" ))]
DNA_row_dist <- which(rownames(weighted_unifrac_distance_matrix) %in% DNA_samples_names_1run)
DNA_col_dist <- which(colnames(weighted_unifrac_distance_matrix) %in% DNA_samples_names_1run)
weighted_unifrac_dist_DNA <- as.dist(weighted_unifrac_distance_matrix[DNA_row_dist, DNA_col_dist]) 
ord.pcoa.weighted_unifrac_dist <- ordinate(ps_DNA, method="PCoA", distance=weighted_unifrac_dist_DNA, na.rm = T)

p<-plot_ordination(ps_DNA, ord.pcoa.weighted_unifrac_dist, color="tank_or_field")
p$data$sample_nr <- as.factor(p$data$sample_nr)  
ggplot(data=p$data, aes(x=Axis.1, y=Axis.2, color=source, label=sample_nr, shape = fraction)) + geom_point(size= 3) + geom_text(hjust=0, vjust=0) + labs(x="PC1", y= "PC2")
```

On this plot we can compare FL and PA from first run of the experiment.
We can notice again more define clusters in FL fraction then PA.
In FL again we can abserve that clusters are ordered according to increase of delta and that field samples are more distinct from delta 4 then from delta 0 or 2.
For PA, it is difficult to point out order of clusters and relation with field samples.

Lets check each Fraction separately over time.
## 1.2 Particulate fraction

```{r}
DNA_samples_names_1run_PA <- DNA_samples_names[which(sample$fraction == "PA")]
DNA_row_dist <- which(rownames(weighted_unifrac_distance_matrix) %in% DNA_samples_names_1run_PA)
DNA_col_dist <- which(colnames(weighted_unifrac_distance_matrix) %in% DNA_samples_names_1run_PA)
weighted_unifrac_dist_DNA <- as.dist(weighted_unifrac_distance_matrix[DNA_row_dist, DNA_col_dist]) 
ord.pcoa.weighted_unifrac_dist <- ordinate(ps_DNA, method="PCoA", distance=weighted_unifrac_dist_DNA, na.rm = T)

p<-plot_ordination(ps_DNA, ord.pcoa.weighted_unifrac_dist, color="tank_or_field")
p$data$sample_nr <- as.factor(p$data$sample_nr)  
ggplot(data=p$data, aes(x=Axis.1, y=Axis.2, color=source, label=sample_nr, shape = fraction)) + geom_point(size= 3) + geom_text(hjust=0, vjust=0) + labs(x="PC1", y="PC2")
```

For PA fraction we can observe separating clusters over time.

## 1.3 Free-living fraction

```{r}
DNA_samples_names_1run_FL <- DNA_samples_names[which(DNA_samples_names!="JG_110D" & sample$fraction == "FL")]
DNA_row_dist <- which(rownames(weighted_unifrac_distance_matrix) %in% DNA_samples_names_1run_FL)
DNA_col_dist <- which(colnames(weighted_unifrac_distance_matrix) %in% DNA_samples_names_1run_FL)
weighted_unifrac_dist_DNA <- as.dist(weighted_unifrac_distance_matrix[DNA_row_dist, DNA_col_dist]) 
ord.pcoa.weighted_unifrac_dist <- ordinate(ps_DNA, method="PCoA", distance=weighted_unifrac_dist_DNA, na.rm = T)

p<-plot_ordination(ps_DNA, ord.pcoa.weighted_unifrac_dist, color="tank_or_field")
p$data$sample_nr <- as.factor(p$data$sample_nr)  
ggplot(data=p$data, aes(x=Axis.1, y=Axis.2, color=source, label=sample_nr, shape = fraction)) + geom_point(size= 3) + geom_text(hjust=0, vjust=0) + labs(x="PC1", y="PC2")
```

For FL clusters also looks more spare over time but more samples would be needed.
# 2.RNA samples analysis

```{r}
#RNA
sample_RNA <- sample[which(sample$DNA_RNA_label == "R"),]
RNA_samples_names <- row.names(sample_RNA)
otu_RNA <- otu[, which(colnames(otu) %in% RNA_samples_names)]
sum_vec <- as.vector(apply(otu_RNA, 1, sum))
otu_RNA.nonzero <- otu_RNA[which(sum_vec!=0),]
otu_RNA.nonzero <- as.matrix(otu_RNA.nonzero)
taxa_RNA.nonzero <- taxa[which(sum_vec!=0)]
taxa_RNA.nonzero <- as.matrix(taxa_RNA.nonzero)
RNAcol <- which(colnames(weighted_unifrac_distance_matrix) %in% RNA_samples_names)
RNArow <- which(rownames(weighted_unifrac_distance_matrix) %in% RNA_samples_names)

weighted_unifrac_dist_RNA <- as.dist(weighted_unifrac_distance_matrix[RNArow, RNAcol]) 

row.names(taxa_RNA.nonzero) <- taxa_RNA.nonzero[,1]
ps_RNA <- phyloseq(otu_table(otu_RNA.nonzero, taxa_are_rows=TRUE), 
                   sample_data(sample_RNA), 
                   tax_table(taxa_RNA.nonzero))

ord.pcoa.weighted_unifrac_dist <- ordinate(ps_RNA, method="PCoA", distance=weighted_unifrac_dist_RNA, na.rm = T)
p<-plot_ordination(ps_RNA, ord.pcoa.weighted_unifrac_dist, color="tank_or_field")
p$data$all <- paste(p$data$sampling_date, p$data$source, p$data$fraction) 
ggplot(data=p$data, aes(x=Axis.1, y=Axis.2, label=sample_nr, color= p$data$all, shape = fraction, )) + geom_point(size= 3) + geom_text(hjust=0, vjust=0) + labs(x="PC1", y= "PC2")
```

In this plot we can notice that again field samples are more distinct in FL fraction then in PA fraction.
FL samples are more variable and form clearer clusters.

## 2.2 Particulate fraction

```{r}
RNA_samples_names_1run_PA <- RNA_samples_names[which(sample$fraction == "PA")]
RNA_row_dist <- which(rownames(weighted_unifrac_distance_matrix) %in% RNA_samples_names_1run_PA)
RNA_col_dist <- which(colnames(weighted_unifrac_distance_matrix) %in% RNA_samples_names_1run_PA)
weighted_unifrac_dist_RNA <- as.dist(weighted_unifrac_distance_matrix[RNA_row_dist, RNA_col_dist]) 
ord.pcoa.weighted_unifrac_dist <- ordinate(ps_RNA, method="PCoA", distance=weighted_unifrac_dist_RNA, na.rm = T)

p<-plot_ordination(ps_RNA, ord.pcoa.weighted_unifrac_dist, color="tank_or_field")
p$data$sample_nr <- as.factor(p$data$sample_nr)  
ggplot(data=p$data, aes(x=Axis.1, y=Axis.2, color=source, label=sample_nr, shape = fraction)) + geom_point(size= 3) + geom_text(hjust=0, vjust=0) + labs(x="PC1", y="PC2")
```

The clusters in PA fraction form fuzzy clusters of different condition.

## 2.3 Free-living fraction

```{r}
RNA_samples_names_1run_FL <- RNA_samples_names[which(RNA_samples_names!="JG_110R" & sample$fraction == "FL")]
RNA_row_dist <- which(rownames(weighted_unifrac_distance_matrix) %in% RNA_samples_names_1run_FL)
RNA_col_dist <- which(colnames(weighted_unifrac_distance_matrix) %in% RNA_samples_names_1run_FL)
weighted_unifrac_dist_RNA <- as.dist(weighted_unifrac_distance_matrix[RNA_row_dist, RNA_col_dist]) 
ord.pcoa.weighted_unifrac_dist <- ordinate(ps_RNA, method="PCoA", distance=weighted_unifrac_dist_RNA, na.rm = T)

p<-plot_ordination(ps_RNA, ord.pcoa.weighted_unifrac_dist, color="tank_or_field")
p$data$sample_nr <- as.factor(p$data$sample_nr)  
ggplot(data=p$data, aes(x=Axis.1, y=Axis.2, color=source, label=sample_nr, shape = fraction)) + geom_point(size= 3) + geom_text(hjust=0, vjust=0) + labs(x="PC1", y="PC2")
```

The tank clusters are closed together but the delta 0 cluster is slightly closest to field samples.

# 3 RNA and DNA comparison

To see if we capture more variation by RNA then DNA a we could expect lets plot them together and then separately.
Since FL and PA was shown to exhibit huge differences lets split them into two plots.

## 3.1 Praticulate fraction

```{r}
sample_first_day_PA <- sample[which((sample$sampling_date == "29/07/2024" | sample$sampling_date == "31/07/2024") & sample$fraction == "PA"),]
sample_first_day_PA_names <- row.names(sample_first_day_PA)

#remove 110 paired samples 
sample_first_day_PA_names <- row.names(sample_first_day_PA)
sample_first_day_PA_names <- sample_first_day_PA_names[which(sample_first_day_PA_names!="JG_110D" & sample_first_day_PA_names!="JG_110R")]
otu_first_day_PA <- otu[,which(colnames(otu) %in% sample_first_day_PA_names)]
sum_vec <- as.vector(apply(otu_first_day_PA, 1, sum))
otu_first_day_PA.nonzero <- otu_first_day_PA[which(sum_vec!=0),]
otu_first_day_PA.nonzero <- as.matrix(otu_first_day_PA.nonzero)
taxa_first_day_PA.nonzero <- taxa[which(sum_vec!=0)]
taxa_first_day_PA.nonzero <- as.matrix(taxa_first_day_PA.nonzero)

first_day_PA_samples_names <- row.names(sample_first_day_PA)
first_day_PAcol <- which(colnames(weighted_unifrac_distance_matrix) %in% first_day_PA_samples_names)
first_day_PArow <- which(rownames(weighted_unifrac_distance_matrix) %in% first_day_PA_samples_names)

weighted_unifrac_dist_first_day_PA <- as.dist(weighted_unifrac_distance_matrix[first_day_PArow, first_day_PAcol]) 

row.names(taxa_first_day_PA.nonzero) <- taxa_first_day_PA.nonzero[,1]
ps_first_day_PA <- phyloseq(otu_table(otu_first_day_PA.nonzero, taxa_are_rows=TRUE), 
                         sample_data(sample_first_day_PA), 
                         tax_table(taxa_first_day_PA.nonzero))

#try unifrac
ord.pcoa.weighted_unifrac_dist <- ordinate(ps_first_day_PA, method="PCoA", distance=weighted_unifrac_dist_first_day_PA, na.rm = T)
p<-plot_ordination(ps_first_day_PA, ord.pcoa.weighted_unifrac_dist, color="tank_or_field")
ggplot(data=p$data, aes(x=Axis.1, y=Axis.2, color=source, shape = DNA_or_RNA)) + geom_point(size= 3) + stat_ellipse(type="norm", level=0.95) + labs(x="PC1", y="PC2")

```

The RNA samples are more variable.
The clusters are hard to distinguished in both DNA and RNA data.

## 3.2 Free-living comparison

```{r}
sample_first_day_FL <- sample[which((sample$sampling_date == "29/07/2024" | sample$sampling_date == "31/07/2024") & sample$fraction == "FL"),]
sample_first_day_FL_names <- row.names(sample_first_day_FL)

#remove 110 paired samples 
sample_first_day_FL_names <- row.names(sample_first_day_FL)
sample_first_day_FL_names <- sample_first_day_FL_names[which(sample_first_day_FL_names!="JG_110D" & sample_first_day_FL_names!="JG_110R")]
otu_first_day_FL <- otu[,which(colnames(otu) %in% sample_first_day_FL_names)]
sum_vec <- as.vector(apply(otu_first_day_FL, 1, sum))
otu_first_day_FL.nonzero <- otu_first_day_FL[which(sum_vec!=0),]
otu_first_day_FL.nonzero <- as.matrix(otu_first_day_FL.nonzero)
taxa_first_day_FL.nonzero <- taxa[which(sum_vec!=0)]
taxa_first_day_FL.nonzero <- as.matrix(taxa_first_day_FL.nonzero)

first_day_FL_samples_names <- row.names(sample_first_day_FL)
first_day_FLcol <- which(colnames(weighted_unifrac_distance_matrix) %in% first_day_FL_samples_names)
first_day_FLrow <- which(rownames(weighted_unifrac_distance_matrix) %in% first_day_FL_samples_names)

weighted_unifrac_dist_first_day_FL <- as.dist(weighted_unifrac_distance_matrix[first_day_FLrow, first_day_FLcol]) 

row.names(taxa_first_day_FL.nonzero) <- taxa_first_day_FL.nonzero[,1]
ps_first_day_FL <- phyloseq(otu_table(otu_first_day_FL.nonzero, taxa_are_rows=TRUE), 
                         sample_data(sample_first_day_FL), 
                         tax_table(taxa_first_day_FL.nonzero))

#try unifrac
ord.pcoa.weighted_unifrac_dist <- ordinate(ps_first_day_FL, method="PCoA", distance=weighted_unifrac_dist_first_day_FL, na.rm = T)
p<-plot_ordination(ps_first_day_FL, ord.pcoa.weighted_unifrac_dist, color="tank_or_field")
ggplot(data=p$data, aes(x=Axis.1, y=Axis.2, color=source, shape = DNA_or_RNA)) + geom_point(size= 3) + stat_ellipse(type="norm", level=0.95) + labs(x="PC1", y="PC2")

```

Both RNA and DNA showed the distinct clusters of temperature condition and in both the closed to field samples is delta 0.
The RNA samples are more variable.

## 3.3 Compare all - weighted and unweighted UniFrac

```{r}
#separated fractions
#FL
#first turn
sample_first_day_FL <- sample[which((sample$sampling_date == "29/07/2024" | sample$sampling_date == "31/07/2024") & sample$fraction == "FL"),]
sample_first_day_FL_names <- row.names(sample_first_day_FL)

#remove 110 paired samples 
sample_first_day_FL_names <- row.names(sample_first_day_FL)
sample_first_day_FL_names <- sample_first_day_FL_names[which(sample_first_day_FL_names!="JG_110D" & sample_first_day_FL_names!="JG_110R")]
otu_first_day_FL <- otu[,which(colnames(otu) %in% sample_first_day_FL_names)]
sum_vec <- as.vector(apply(otu_first_day_FL, 1, sum))
otu_first_day_FL.nonzero <- otu_first_day_FL[which(sum_vec!=0),]
otu_first_day_FL.nonzero <- as.matrix(otu_first_day_FL.nonzero)
taxa_first_day_FL.nonzero <- taxa[which(sum_vec!=0)]
taxa_first_day_FL.nonzero <- as.matrix(taxa_first_day_FL.nonzero)

first_day_FL_samples_names <- row.names(sample_first_day_FL)
first_day_FLcol <- which(colnames(weighted_unifrac_distance_matrix) %in% first_day_FL_samples_names)
first_day_FLrow <- which(rownames(weighted_unifrac_distance_matrix) %in% first_day_FL_samples_names)

weighted_unifrac_dist_first_day_FL <- as.dist(weighted_unifrac_distance_matrix[first_day_FLrow, first_day_FLcol]) 

row.names(taxa_first_day_FL.nonzero) <- taxa_first_day_FL.nonzero[,1]
ps_first_day_FL <- phyloseq(otu_table(otu_first_day_FL.nonzero, taxa_are_rows=TRUE), 
                         sample_data(sample_first_day_FL), 
                         tax_table(taxa_first_day_FL.nonzero))

#try unifrac
ord.pcoa.weighted_unifrac_dist <- ordinate(ps_first_day_FL, method="PCoA", distance=weighted_unifrac_dist_first_day_FL, na.rm = T)
#PA
#first turn
#DNA
sample_first_day_PA_DNA_first_run <- sample[which((sample$sampling_date == "29/07/2024" | sample$sampling_date == "31/07/2024") & sample$fraction == "PA" & sample$DNA_or_RNA == "DNA"),]
sample_first_day_PA_DNA_first_run_names <- row.names(sample_first_day_PA_DNA_first_run)
otu_first_day_PA_DNA_first_run <- otu[,which(colnames(otu) %in% sample_first_day_PA_DNA_first_run_names)]
sum_vec <- as.vector(apply(otu_first_day_PA_DNA_first_run, 1, sum))
otu_first_day_PA_DNA_first_run.nonzero <- otu_first_day_PA_DNA_first_run[which(sum_vec!=0),]
otu_first_day_PA_DNA_first_run.nonzero <- as.matrix(otu_first_day_PA_DNA_first_run.nonzero)
taxa_first_day_PA_DNA_first_run.nonzero <- taxa[which(sum_vec!=0)]
taxa_first_day_PA_DNA_first_run.nonzero <- as.matrix(taxa_first_day_PA_DNA_first_run.nonzero)

first_day_PA_DNA_first_run_samples_names <- row.names(sample_first_day_PA_DNA_first_run)
#remove 110
first_day_PA_DNA_first_run_samples_names <- first_day_PA_DNA_first_run_samples_names[which(first_day_PA_DNA_first_run_samples_names!="JG_110D" & first_day_PA_DNA_first_run_samples_names!="JG_110R")]
first_day_PA_DNA_first_runcol <- which(colnames(weighted_unifrac_distance_matrix) %in% first_day_PA_DNA_first_run_samples_names)
first_day_PA_DNA_first_runrow <- which(rownames(weighted_unifrac_distance_matrix) %in% first_day_PA_DNA_first_run_samples_names)

weighted_unifrac_dist_first_day_PA_DNA_first_run <- as.dist(weighted_unifrac_distance_matrix[first_day_PA_DNA_first_runrow, first_day_PA_DNA_first_runcol]) 

row.names(taxa_first_day_PA_DNA_first_run.nonzero) <- taxa_first_day_PA_DNA_first_run.nonzero[,1]
ps_first_day_PA_DNA_first_run <- phyloseq(otu_table(otu_first_day_PA_DNA_first_run.nonzero, taxa_are_rows=TRUE), 
                            sample_data(sample_first_day_PA_DNA_first_run), 
                            tax_table(taxa_first_day_PA_DNA_first_run.nonzero), treefile)

ord.pcoa.unweighted_unifrac_dist.first_day_PA_DNA_first_run <- ordinate(ps_first_day_PA_DNA_first_run, method="PCoA", distance="unifrac", weighted=FALSE)

unweighted_unifrac_dist_first_day_PA_DNA_first_run <-distance(ps_first_day_PA_DNA_first_run, "unifrac", type = "samples")

DNA_PA_plot <- plot_ordination(ps_first_day_PA_DNA_first_run, ord.pcoa.unweighted_unifrac_dist.first_day_PA_DNA_first_run, color="source") + theme(legend.position ="none") +  stat_ellipse(level = 0.95)
DNA_PA_plot_leg <- plot_ordination(ps_first_day_PA_DNA_first_run, ord.pcoa.unweighted_unifrac_dist.first_day_PA_DNA_first_run, color="source")
ord.pcoa.weighted_unifrac_dist.first_day_PA_DNA_first_run <- ordinate(ps_first_day_PA_DNA_first_run, method="PCoA", distance=weighted_unifrac_dist_first_day_PA_DNA_first_run)
DNA_PA_plot_weighted <- plot_ordination(ps_first_day_PA_DNA_first_run, ord.pcoa.weighted_unifrac_dist.first_day_PA_DNA_first_run, color="source")  + theme(legend.position ="none") + stat_ellipse(level = 0.95)


#FL
#first turn
#DNA
sample_first_day_FL_DNA_first_run <- sample[which((sample$sampling_date == "29/07/2024" | sample$sampling_date == "31/07/2024") & sample$fraction == "FL" & sample$DNA_or_RNA == "DNA"),]
sample_first_day_FL_DNA_first_run_names <- row.names(sample_first_day_FL_DNA_first_run)
otu_first_day_FL_DNA_first_run <- otu[,which(colnames(otu) %in% sample_first_day_FL_DNA_first_run_names)]
sum_vec <- as.vector(apply(otu_first_day_FL_DNA_first_run, 1, sum))
otu_first_day_FL_DNA_first_run.nonzero <- otu_first_day_FL_DNA_first_run[which(sum_vec!=0),]
otu_first_day_FL_DNA_first_run.nonzero <- as.matrix(otu_first_day_FL_DNA_first_run.nonzero)
taxa_first_day_FL_DNA_first_run.nonzero <- taxa[which(sum_vec!=0)]
taxa_first_day_FL_DNA_first_run.nonzero <- as.matrix(taxa_first_day_FL_DNA_first_run.nonzero)

first_day_FL_DNA_first_run_samples_names <- row.names(sample_first_day_FL_DNA_first_run)
#remove 110
first_day_FL_DNA_first_run_samples_names <- first_day_FL_DNA_first_run_samples_names[which(first_day_FL_DNA_first_run_samples_names!="JG_110D" & first_day_FL_DNA_first_run_samples_names!="JG_110R")]
first_day_FL_DNA_first_runcol <- which(colnames(weighted_unifrac_distance_matrix) %in% first_day_FL_DNA_first_run_samples_names)
first_day_FL_DNA_first_runrow <- which(rownames(weighted_unifrac_distance_matrix) %in% first_day_FL_DNA_first_run_samples_names)

weighted_unifrac_dist_first_day_FL_DNA_first_run <- as.dist(weighted_unifrac_distance_matrix[first_day_FL_DNA_first_runrow, first_day_FL_DNA_first_runcol]) 
unweighted_unifrac_dist_first_day_FL_DNA_first_run <-distance(ps_first_day_FL_DNA_first_run, "unifrac", type = "samples")

row.names(taxa_first_day_FL_DNA_first_run.nonzero) <- taxa_first_day_FL_DNA_first_run.nonzero[,1]
ps_first_day_FL_DNA_first_run <- phyloseq(otu_table(otu_first_day_FL_DNA_first_run.nonzero, taxa_are_rows=TRUE), 
                                          sample_data(sample_first_day_FL_DNA_first_run), 
                                          tax_table(taxa_first_day_FL_DNA_first_run.nonzero), treefile)

ord.pcoa.unweighted_unifrac_dist.first_day_FL_DNA_first_run <- ordinate(ps_first_day_FL_DNA_first_run, method="PCoA", distance="unifrac", weighted=FALSE)
DNA_FL_plot <- plot_ordination(ps_first_day_FL_DNA_first_run, ord.pcoa.unweighted_unifrac_dist.first_day_FL_DNA_first_run, color="source") + theme(legend.position ="none") + stat_ellipse(level = 0.95)

ord.pcoa.weighted_unifrac_dist.first_day_FL_DNA_first_run <- ordinate(ps_first_day_FL_DNA_first_run, method="PCoA", distance=weighted_unifrac_dist_first_day_FL_DNA_first_run)
DNA_FL_plot_weighted <- plot_ordination(ps_first_day_FL_DNA_first_run, ord.pcoa.weighted_unifrac_dist.first_day_FL_DNA_first_run, color="source") + theme(legend.position ="none") + stat_ellipse(level = 0.95)


#PA
#first turn
#RNA
sample_first_day_PA_RNA_first_run <- sample[which((sample$sampling_date == "29/07/2024" | sample$sampling_date == "31/07/2024") & sample$fraction == "PA" & sample$DNA_or_RNA == "RNA"),]
sample_first_day_PA_RNA_first_run_names <- row.names(sample_first_day_PA_RNA_first_run)
otu_first_day_PA_RNA_first_run <- otu[,which(colnames(otu) %in% sample_first_day_PA_RNA_first_run_names)]
sum_vec <- as.vector(apply(otu_first_day_PA_RNA_first_run, 1, sum))
otu_first_day_PA_RNA_first_run.nonzero <- otu_first_day_PA_RNA_first_run[which(sum_vec!=0),]
otu_first_day_PA_RNA_first_run.nonzero <- as.matrix(otu_first_day_PA_RNA_first_run.nonzero)
taxa_first_day_PA_RNA_first_run.nonzero <- taxa[which(sum_vec!=0)]
taxa_first_day_PA_RNA_first_run.nonzero <- as.matrix(taxa_first_day_PA_RNA_first_run.nonzero)

first_day_PA_RNA_first_run_samples_names <- row.names(sample_first_day_PA_RNA_first_run)
#remove 110
first_day_PA_RNA_first_run_samples_names <- first_day_PA_RNA_first_run_samples_names[which(first_day_PA_RNA_first_run_samples_names!="JG_110D" & first_day_PA_RNA_first_run_samples_names!="JG_110R")]
first_day_PA_RNA_first_runcol <- which(colnames(weighted_unifrac_distance_matrix) %in% first_day_PA_RNA_first_run_samples_names)
first_day_PA_RNA_first_runrow <- which(rownames(weighted_unifrac_distance_matrix) %in% first_day_PA_RNA_first_run_samples_names)

weighted_unifrac_dist_first_day_PA_RNA_first_run <- as.dist(weighted_unifrac_distance_matrix[first_day_PA_RNA_first_runrow, first_day_PA_RNA_first_runcol]) 

row.names(taxa_first_day_PA_RNA_first_run.nonzero) <- taxa_first_day_PA_RNA_first_run.nonzero[,1]
ps_first_day_PA_RNA_first_run <- phyloseq(otu_table(otu_first_day_PA_RNA_first_run.nonzero, taxa_are_rows=TRUE), 
                                          sample_data(sample_first_day_PA_RNA_first_run), 
                                          tax_table(taxa_first_day_PA_RNA_first_run.nonzero), treefile)

ord.pcoa.unweighted_unifrac_dist.first_day_PA_RNA_first_run <- ordinate(ps_first_day_PA_RNA_first_run, method="PCoA", distance="unifrac", weighted=FALSE)
unweighted_unifrac_dist_first_day_PA_RNA_first_run <-distance(ps_first_day_PA_RNA_first_run, "unifrac", type = "samples")

RNA_PA_plot <- plot_ordination(ps_first_day_PA_RNA_first_run, ord.pcoa.unweighted_unifrac_dist.first_day_PA_RNA_first_run, color="source") + theme(legend.position ="none") + stat_ellipse(level = 0.95)
ord.pcoa.weighted_unifrac_dist.first_day_PA_RNA_first_run <- ordinate(ps_first_day_PA_RNA_first_run, method="PCoA", distance=weighted_unifrac_dist_first_day_PA_RNA_first_run)
RNA_PA_plot_weighted <- plot_ordination(ps_first_day_PA_RNA_first_run, ord.pcoa.weighted_unifrac_dist.first_day_PA_RNA_first_run, color="source") + theme(legend.position ="none") + stat_ellipse(level = 0.95)


#FL
#first turn
#RNA
sample_first_day_FL_RNA_first_run <- sample[which((sample$sampling_date == "29/07/2024" | sample$sampling_date == "31/07/2024") & sample$fraction == "FL" & sample$DNA_or_RNA == "RNA"),]
sample_first_day_FL_RNA_first_run_names <- row.names(sample_first_day_FL_RNA_first_run)
otu_first_day_FL_RNA_first_run <- otu[,which(colnames(otu) %in% sample_first_day_FL_RNA_first_run_names)]
sum_vec <- as.vector(apply(otu_first_day_FL_RNA_first_run, 1, sum))
otu_first_day_FL_RNA_first_run.nonzero <- otu_first_day_FL_RNA_first_run[which(sum_vec!=0),]
otu_first_day_FL_RNA_first_run.nonzero <- as.matrix(otu_first_day_FL_RNA_first_run.nonzero)
taxa_first_day_FL_RNA_first_run.nonzero <- taxa[which(sum_vec!=0)]
taxa_first_day_FL_RNA_first_run.nonzero <- as.matrix(taxa_first_day_FL_RNA_first_run.nonzero)

first_day_FL_RNA_first_run_samples_names <- row.names(sample_first_day_FL_RNA_first_run)
#remove 110
first_day_FL_RNA_first_run_samples_names <- first_day_FL_RNA_first_run_samples_names[which(first_day_FL_RNA_first_run_samples_names!="JG_110D" & first_day_FL_RNA_first_run_samples_names!="JG_110R")]
first_day_FL_RNA_first_runcol <- which(colnames(weighted_unifrac_distance_matrix) %in% first_day_FL_RNA_first_run_samples_names)
first_day_FL_RNA_first_runrow <- which(rownames(weighted_unifrac_distance_matrix) %in% first_day_FL_RNA_first_run_samples_names)

weighted_unifrac_dist_first_day_FL_RNA_first_run <- as.dist(weighted_unifrac_distance_matrix[first_day_FL_RNA_first_runrow, first_day_FL_RNA_first_runcol]) 
unweighted_unifrac_dist_first_day_FL_RNA_first_run <-distance(ps_first_day_FL_RNA_first_run, "unifrac", type = "samples")

row.names(taxa_first_day_FL_RNA_first_run.nonzero) <- taxa_first_day_FL_RNA_first_run.nonzero[,1]
ps_first_day_FL_RNA_first_run <- phyloseq(otu_table(otu_first_day_FL_RNA_first_run.nonzero, taxa_are_rows=TRUE), 
                                          sample_data(sample_first_day_FL_RNA_first_run), 
                                          tax_table(taxa_first_day_FL_RNA_first_run.nonzero), treefile)
ord.pcoa.unweighted_unifrac_dist.first_day_FL_RNA_first_run <- ordinate(ps_first_day_FL_RNA_first_run, method="PCoA", distance="unifrac", weighted=FALSE)
RNA_FL_plot <- plot_ordination(ps_first_day_FL_RNA_first_run, ord.pcoa.unweighted_unifrac_dist.first_day_FL_RNA_first_run, color="source") + theme(legend.position ="none") + stat_ellipse(level = 0.95)
ord.pcoa.weighted_unifrac_dist.first_day_FL_RNA_first_run <- ordinate(ps_first_day_FL_RNA_first_run, method="PCoA", distance=weighted_unifrac_dist_first_day_FL_RNA_first_run) 
RNA_FL_plot_weighted <- plot_ordination(ps_first_day_FL_RNA_first_run, ord.pcoa.weighted_unifrac_dist.first_day_FL_RNA_first_run, color="source") + theme(legend.position ="none") + stat_ellipse(level = 0.95)

#plot all together 
title_gg_unweighted <- ggdraw() + draw_label("Unweighted UniFrac", fontface='bold', hjust=0.5)
title_gg_weighted <- ggdraw() + draw_label("Weighted UniFrac", fontface='bold', hjust=0.5)
#unweighted
unweigted_no_legend <- plot_grid(RNA_PA_plot + theme(plot.margin = unit(c(2,2,2,2), "lines")), DNA_PA_plot + theme(plot.margin = unit(c(2,2,2,2), "lines"))  + theme(legend.position ="none"), RNA_FL_plot + theme(plot.margin = unit(c(2,2,2,2), "lines")), DNA_FL_plot + theme(plot.margin = unit(c(2,2,2,2), "lines")), labels = c('A) RNA PA', 'B) DNA PA', 'C) RNA FL', 'D) DNA FL'), label_size = 12) + ggtitle("Unweigted unifrac")
legend <- get_legend(
  # create some space to the left of the legend
  DNA_PA_plot_leg
)

unweighted_legend <- plot_grid(unweigted_no_legend, legend, rel_widths = c(4, 1), ncol=2)
unweighted_legend <- plot_grid(title_gg_unweighted, unweighted_legend, ncol=1, rel_heights=c(0.1, 1), align = "h")
unweighted_legend
#weighted
weigthed_no_legend <- plot_grid(RNA_PA_plot_weighted + theme(plot.margin = unit(c(2,2,2,2), "lines")), DNA_PA_plot_weighted + theme(plot.margin = unit(c(2,2,2,2), "lines")), RNA_FL_plot_weighted + theme(plot.margin = unit(c(2,2,2,2), "lines")), DNA_FL_plot_weighted + theme(plot.margin = unit(c(2,2,2,2), "lines")), labels = c('A) RNA PA', 'B) DNA PA', 'C) RNA FL', 'D) DNA FL'), label_size = 12)
weigthed_legend <- plot_grid(weigthed_no_legend, legend, ncol=2, rel_widths = c(4, 1))
weigthed_legend <- plot_grid(title_gg_weighted, weigthed_legend, ncol=1, rel_heights=c(0.1, 1), aligh = "h")
weigthed_legend

```

### 3.3.0 Check how clusters are formed after removing field samples.

```{r}
#separated fractions
#FL
#first turn
sample_first_day_FL <- sample[which(sample$sampling_date == "31/07/2024" & sample$fraction == "FL"),]
sample_first_day_FL_names <- row.names(sample_first_day_FL)

#remove 110 paired samples 
sample_first_day_FL_names <- row.names(sample_first_day_FL)
sample_first_day_FL_names <- sample_first_day_FL_names[which(sample_first_day_FL_names!="JG_110D" & sample_first_day_FL_names!="JG_110R")]
otu_first_day_FL <- otu[,which(colnames(otu) %in% sample_first_day_FL_names)]
sum_vec <- as.vector(apply(otu_first_day_FL, 1, sum))
otu_first_day_FL.nonzero <- otu_first_day_FL[which(sum_vec!=0),]
otu_first_day_FL.nonzero <- as.matrix(otu_first_day_FL.nonzero)
taxa_first_day_FL.nonzero <- taxa[which(sum_vec!=0)]
taxa_first_day_FL.nonzero <- as.matrix(taxa_first_day_FL.nonzero)

first_day_FL_samples_names <- row.names(sample_first_day_FL)
first_day_FLcol <- which(colnames(weighted_unifrac_distance_matrix) %in% first_day_FL_samples_names)
first_day_FLrow <- which(rownames(weighted_unifrac_distance_matrix) %in% first_day_FL_samples_names)

weighted_unifrac_dist_first_day_FL <- as.dist(weighted_unifrac_distance_matrix[first_day_FLrow, first_day_FLcol]) 

row.names(taxa_first_day_FL.nonzero) <- taxa_first_day_FL.nonzero[,1]
ps_first_day_FL <- phyloseq(otu_table(otu_first_day_FL.nonzero, taxa_are_rows=TRUE), 
                         sample_data(sample_first_day_FL), 
                         tax_table(taxa_first_day_FL.nonzero))

#try unifrac
ord.pcoa.weighted_unifrac_dist <- ordinate(ps_first_day_FL, method="PCoA", distance=weighted_unifrac_dist_first_day_FL, na.rm = T)
#PA
#first turn
#DNA
sample_first_day_PA_DNA_first_run <- sample[which((sample$sampling_date == "31/07/2024") & sample$fraction == "PA" & sample$DNA_or_RNA == "DNA" & row.names(sample_first_day_PA_DNA_first_run)!="JG_110D" ),]
sample_first_day_PA_DNA_first_run_names <- row.names(sample_first_day_PA_DNA_first_run)
otu_first_day_PA_DNA_first_run <- otu[,which(colnames(otu) %in% sample_first_day_PA_DNA_first_run_names)]
sum_vec <- as.vector(apply(otu_first_day_PA_DNA_first_run, 1, sum))
otu_first_day_PA_DNA_first_run.nonzero <- otu_first_day_PA_DNA_first_run[which(sum_vec!=0),]
otu_first_day_PA_DNA_first_run.nonzero <- as.matrix(otu_first_day_PA_DNA_first_run.nonzero)
taxa_first_day_PA_DNA_first_run.nonzero <- taxa[which(sum_vec!=0)]
taxa_first_day_PA_DNA_first_run.nonzero <- as.matrix(taxa_first_day_PA_DNA_first_run.nonzero)

# first_day_PA_DNA_first_run_samples_names <- row.names(sample_first_day_PA_DNA_first_run)
# #remove 110
# first_day_PA_DNA_first_run_samples_names <- first_day_PA_DNA_first_run_samples_names[which(first_day_PA_DNA_first_run_samples_names!="JG_110D" & first_day_PA_DNA_first_run_samples_names!="JG_110R")]
first_day_PA_DNA_first_runcol <- which(colnames(weighted_unifrac_distance_matrix) %in% sample_first_day_PA_DNA_first_run_names)
first_day_PA_DNA_first_runrow <- which(rownames(weighted_unifrac_distance_matrix) %in% sample_first_day_PA_DNA_first_run_names)

weighted_unifrac_dist_first_day_PA_DNA_first_run <- as.dist(weighted_unifrac_distance_matrix[first_day_PA_DNA_first_runrow, first_day_PA_DNA_first_runcol]) 

row.names(taxa_first_day_PA_DNA_first_run.nonzero) <- taxa_first_day_PA_DNA_first_run.nonzero[,1]
ps_first_day_PA_DNA_first_run <- phyloseq(otu_table(otu_first_day_PA_DNA_first_run.nonzero, taxa_are_rows=TRUE), 
                            sample_data(sample_first_day_PA_DNA_first_run), 
                            tax_table(taxa_first_day_PA_DNA_first_run.nonzero), treefile)

ord.pcoa.unweighted_unifrac_dist.first_day_PA_DNA_first_run <- ordinate(ps_first_day_PA_DNA_first_run, method="PCoA", distance="unifrac", weighted=FALSE)

unweighted_unifrac_dist_first_day_PA_DNA_first_run <-distance(ps_first_day_PA_DNA_first_run, "unifrac", type = "samples")

DNA_PA_plot <- plot_ordination(ps_first_day_PA_DNA_first_run, ord.pcoa.unweighted_unifrac_dist.first_day_PA_DNA_first_run, color="source") + theme(legend.position ="none") +  stat_ellipse(level = 0.95)
DNA_PA_plot_leg <- plot_ordination(ps_first_day_PA_DNA_first_run, ord.pcoa.unweighted_unifrac_dist.first_day_PA_DNA_first_run, color="source")
ord.pcoa.weighted_unifrac_dist.first_day_PA_DNA_first_run <- ordinate(ps_first_day_PA_DNA_first_run, method="PCoA", distance=weighted_unifrac_dist_first_day_PA_DNA_first_run)
DNA_PA_plot_weighted <- plot_ordination(ps_first_day_PA_DNA_first_run, ord.pcoa.weighted_unifrac_dist.first_day_PA_DNA_first_run, color="source")  + theme(legend.position ="none") + stat_ellipse(level = 0.95)

# ord.pcoa.weighted_unifrac_dist.first_day_PA_DNA_first_run_NMDS <- ordinate(ps_first_day_PA_DNA_first_run, method="NMDS", distance=weighted_unifrac_dist_first_day_PA_DNA_first_run)
# DNA_PA_plot_weighted_NMDS <- plot_ordination(ps_first_day_PA_DNA_first_run, ord.pcoa.weighted_unifrac_dist.first_day_PA_DNA_first_run_NMDS, color="source")  + theme(legend.position ="none") + stat_ellipse(level = 0.95)

#FL
#first turn
#DNA
sample_first_day_FL_DNA_first_run <- sample[which((sample$sampling_date == "31/07/2024") & sample$fraction == "FL" & sample$DNA_or_RNA == "DNA"),]
sample_first_day_FL_DNA_first_run_names <- row.names(sample_first_day_FL_DNA_first_run)
otu_first_day_FL_DNA_first_run <- otu[,which(colnames(otu) %in% sample_first_day_FL_DNA_first_run_names)]
sum_vec <- as.vector(apply(otu_first_day_FL_DNA_first_run, 1, sum))
otu_first_day_FL_DNA_first_run.nonzero <- otu_first_day_FL_DNA_first_run[which(sum_vec!=0),]
otu_first_day_FL_DNA_first_run.nonzero <- as.matrix(otu_first_day_FL_DNA_first_run.nonzero)
taxa_first_day_FL_DNA_first_run.nonzero <- taxa[which(sum_vec!=0)]
taxa_first_day_FL_DNA_first_run.nonzero <- as.matrix(taxa_first_day_FL_DNA_first_run.nonzero)

first_day_FL_DNA_first_run_samples_names <- row.names(sample_first_day_FL_DNA_first_run)
#remove 110
first_day_FL_DNA_first_run_samples_names <- first_day_FL_DNA_first_run_samples_names[which(first_day_FL_DNA_first_run_samples_names!="JG_110D" & first_day_FL_DNA_first_run_samples_names!="JG_110R")]
first_day_FL_DNA_first_runcol <- which(colnames(weighted_unifrac_distance_matrix) %in% first_day_FL_DNA_first_run_samples_names)
first_day_FL_DNA_first_runrow <- which(rownames(weighted_unifrac_distance_matrix) %in% first_day_FL_DNA_first_run_samples_names)

weighted_unifrac_dist_first_day_FL_DNA_first_run <- as.dist(weighted_unifrac_distance_matrix[first_day_FL_DNA_first_runrow, first_day_FL_DNA_first_runcol]) 
unweighted_unifrac_dist_first_day_FL_DNA_first_run <-distance(ps_first_day_FL_DNA_first_run, "unifrac", type = "samples")

row.names(taxa_first_day_FL_DNA_first_run.nonzero) <- taxa_first_day_FL_DNA_first_run.nonzero[,1]
ps_first_day_FL_DNA_first_run <- phyloseq(otu_table(otu_first_day_FL_DNA_first_run.nonzero, taxa_are_rows=TRUE), 
                                          sample_data(sample_first_day_FL_DNA_first_run), 
                                          tax_table(taxa_first_day_FL_DNA_first_run.nonzero), treefile)

ord.pcoa.unweighted_unifrac_dist.first_day_FL_DNA_first_run <- ordinate(ps_first_day_FL_DNA_first_run, method="PCoA", distance="unifrac", weighted=FALSE)
DNA_FL_plot <- plot_ordination(ps_first_day_FL_DNA_first_run, ord.pcoa.unweighted_unifrac_dist.first_day_FL_DNA_first_run, color="source") + theme(legend.position ="none") + stat_ellipse(level = 0.95)

ord.pcoa.weighted_unifrac_dist.first_day_FL_DNA_first_run <- ordinate(ps_first_day_FL_DNA_first_run, method="PCoA", distance=weighted_unifrac_dist_first_day_FL_DNA_first_run)
DNA_FL_plot_weighted <- plot_ordination(ps_first_day_FL_DNA_first_run, ord.pcoa.weighted_unifrac_dist.first_day_FL_DNA_first_run, color="source") + theme(legend.position ="none") + stat_ellipse(level = 0.95)
# ord.pcoa.weighted_unifrac_dist.first_day_FL_DNA_first_run_NMDS <- ordinate(ps_first_day_FL_DNA_first_run, method="NMDS", distance=weighted_unifrac_dist_first_day_FL_DNA_first_run)
# DNA_FL_plot_weighted_NMSD <- plot_ordination(ps_first_day_FL_DNA_first_run, ord.pcoa.weighted_unifrac_dist.first_day_FL_DNA_first_run_NMDS, color="source") + theme(legend.position ="none") + stat_ellipse(level = 0.95)


#PA
#first turn
#RNA
sample_first_day_PA_RNA_first_run <- sample[which((sample$sampling_date == "31/07/2024") & sample$fraction == "PA" & sample$DNA_or_RNA == "RNA", row.names(sample_first_day_PA_RNA_first_run)!="JG_110R"),]
sample_first_day_PA_RNA_first_run_names <- row.names(sample_first_day_PA_RNA_first_run)
otu_first_day_PA_RNA_first_run <- otu[,which(colnames(otu) %in% sample_first_day_PA_RNA_first_run_names)]
sum_vec <- as.vector(apply(otu_first_day_PA_RNA_first_run, 1, sum))
otu_first_day_PA_RNA_first_run.nonzero <- otu_first_day_PA_RNA_first_run[which(sum_vec!=0),]
otu_first_day_PA_RNA_first_run.nonzero <- as.matrix(otu_first_day_PA_RNA_first_run.nonzero)
taxa_first_day_PA_RNA_first_run.nonzero <- taxa[which(sum_vec!=0)]
taxa_first_day_PA_RNA_first_run.nonzero <- as.matrix(taxa_first_day_PA_RNA_first_run.nonzero)

# first_day_PA_RNA_first_run_samples_names <- row.names(sample_first_day_PA_RNA_first_run)
# #remove 110
# first_day_PA_RNA_first_run_samples_names <- first_day_PA_RNA_first_run_samples_names[which(first_day_PA_RNA_first_run_samples_names!="JG_110D" & first_day_PA_RNA_first_run_samples_names!="JG_110R")]
first_day_PA_RNA_first_runcol <- which(colnames(weighted_unifrac_distance_matrix) %in% sample_first_day_PA_RNA_first_run_names)
first_day_PA_RNA_first_runrow <- which(rownames(weighted_unifrac_distance_matrix) %in% sample_first_day_PA_RNA_first_run_names)

weighted_unifrac_dist_first_day_PA_RNA_first_run <- as.dist(weighted_unifrac_distance_matrix[first_day_PA_RNA_first_runrow, first_day_PA_RNA_first_runcol]) 

row.names(taxa_first_day_PA_RNA_first_run.nonzero) <- taxa_first_day_PA_RNA_first_run.nonzero[,1]
ps_first_day_PA_RNA_first_run <- phyloseq(otu_table(otu_first_day_PA_RNA_first_run.nonzero, taxa_are_rows=TRUE), 
                                          sample_data(sample_first_day_PA_RNA_first_run), 
                                          tax_table(taxa_first_day_PA_RNA_first_run.nonzero), treefile)

ord.pcoa.unweighted_unifrac_dist.first_day_PA_RNA_first_run <- ordinate(ps_first_day_PA_RNA_first_run, method="PCoA", distance="unifrac", weighted=FALSE)
unweighted_unifrac_dist_first_day_PA_RNA_first_run <-distance(ps_first_day_PA_RNA_first_run, "unifrac", type = "samples")

RNA_PA_plot <- plot_ordination(ps_first_day_PA_RNA_first_run, ord.pcoa.unweighted_unifrac_dist.first_day_PA_RNA_first_run, color="source") + theme(legend.position ="none") + stat_ellipse(level = 0.95)
ord.pcoa.weighted_unifrac_dist.first_day_PA_RNA_first_run <- ordinate(ps_first_day_PA_RNA_first_run, method="PCoA", distance=weighted_unifrac_dist_first_day_PA_RNA_first_run)
RNA_PA_plot_weighted <- plot_ordination(ps_first_day_PA_RNA_first_run, ord.pcoa.weighted_unifrac_dist.first_day_PA_RNA_first_run, color="source") + theme(legend.position ="none") + stat_ellipse(level = 0.95)


#FL
#first turn
#RNA
sample_first_day_FL_RNA_first_run <- sample[which(( sample$sampling_date == "31/07/2024") & sample$fraction == "FL" & sample$DNA_or_RNA == "RNA"),]
sample_first_day_FL_RNA_first_run_names <- row.names(sample_first_day_FL_RNA_first_run)
otu_first_day_FL_RNA_first_run <- otu[,which(colnames(otu) %in% sample_first_day_FL_RNA_first_run_names)]
sum_vec <- as.vector(apply(otu_first_day_FL_RNA_first_run, 1, sum))
otu_first_day_FL_RNA_first_run.nonzero <- otu_first_day_FL_RNA_first_run[which(sum_vec!=0),]
otu_first_day_FL_RNA_first_run.nonzero <- as.matrix(otu_first_day_FL_RNA_first_run.nonzero)
taxa_first_day_FL_RNA_first_run.nonzero <- taxa[which(sum_vec!=0)]
taxa_first_day_FL_RNA_first_run.nonzero <- as.matrix(taxa_first_day_FL_RNA_first_run.nonzero)

first_day_FL_RNA_first_run_samples_names <- row.names(sample_first_day_FL_RNA_first_run)
#remove 110
first_day_FL_RNA_first_run_samples_names <- first_day_FL_RNA_first_run_samples_names[which(first_day_FL_RNA_first_run_samples_names!="JG_110D" & first_day_FL_RNA_first_run_samples_names!="JG_110R")]
first_day_FL_RNA_first_runcol <- which(colnames(weighted_unifrac_distance_matrix) %in% first_day_FL_RNA_first_run_samples_names)
first_day_FL_RNA_first_runrow <- which(rownames(weighted_unifrac_distance_matrix) %in% first_day_FL_RNA_first_run_samples_names)

weighted_unifrac_dist_first_day_FL_RNA_first_run <- as.dist(weighted_unifrac_distance_matrix[first_day_FL_RNA_first_runrow, first_day_FL_RNA_first_runcol]) 
unweighted_unifrac_dist_first_day_FL_RNA_first_run <-distance(ps_first_day_FL_RNA_first_run, "unifrac", type = "samples")

row.names(taxa_first_day_FL_RNA_first_run.nonzero) <- taxa_first_day_FL_RNA_first_run.nonzero[,1]
ps_first_day_FL_RNA_first_run <- phyloseq(otu_table(otu_first_day_FL_RNA_first_run.nonzero, taxa_are_rows=TRUE), 
                                          sample_data(sample_first_day_FL_RNA_first_run), 
                                          tax_table(taxa_first_day_FL_RNA_first_run.nonzero), treefile)
ord.pcoa.unweighted_unifrac_dist.first_day_FL_RNA_first_run <- ordinate(ps_first_day_FL_RNA_first_run, method="PCoA", distance="unifrac", weighted=FALSE)
RNA_FL_plot <- plot_ordination(ps_first_day_FL_RNA_first_run, ord.pcoa.unweighted_unifrac_dist.first_day_FL_RNA_first_run, color="source") + theme(legend.position ="none") + stat_ellipse(level = 0.95)
ord.pcoa.weighted_unifrac_dist.first_day_FL_RNA_first_run <- ordinate(ps_first_day_FL_RNA_first_run, method="PCoA", distance=weighted_unifrac_dist_first_day_FL_RNA_first_run) 


RNA_FL_plot_weighted <- plot_ordination(ps_first_day_FL_RNA_first_run, ord.pcoa.weighted_unifrac_dist.first_day_FL_RNA_first_run, color="source") + theme(legend.position ="none") + stat_ellipse(level = 0.95)
#NMDS
# ord.pcoa.weighted_unifrac_dist.first_day_FL_RNA_first_run <- ordinate(ps_first_day_FL_RNA_first_run, method="NMDS", distance=weighted_unifrac_dist_first_day_FL_RNA_first_run) 
# RNA_FL_plot_weighted_NMSD <- plot_ordination(ps_first_day_FL_RNA_first_run, ord.pcoa.weighted_unifrac_dist.first_day_FL_RNA_first_run, color="source") + theme(legend.position ="none") + stat_ellipse(level = 0.95)

#plot all together 
title_gg_unweighted <- ggdraw() + draw_label("Unweighted UniFrac", fontface='bold', hjust=0.5)
title_gg_weighted <- ggdraw() + draw_label("Weighted UniFrac", fontface='bold', hjust=0.5)
#unweighted
unweigted_no_legend <- plot_grid(RNA_PA_plot + theme(plot.margin = unit(c(2,2,2,2), "lines")), DNA_PA_plot + theme(plot.margin = unit(c(2,2,2,2), "lines"))  + theme(legend.position ="none"), RNA_FL_plot + theme(plot.margin = unit(c(2,2,2,2), "lines")), DNA_FL_plot + theme(plot.margin = unit(c(2,2,2,2), "lines")), labels = c('A) RNA PA', 'B) DNA PA', 'C) RNA FL', 'D) DNA FL'), label_size = 12) + ggtitle("Unweigted unifrac")
legend <- get_legend(
  # create some space to the left of the legend
  DNA_PA_plot_leg
)

unweighted_legend <- plot_grid(unweigted_no_legend, legend, rel_widths = c(4, 1), ncol=2)
unweighted_legend <- plot_grid(title_gg_unweighted, unweighted_legend, ncol=1, rel_heights=c(0.1, 1), align = "h")
unweighted_legend
#weighted
weigthed_no_legend <- plot_grid(RNA_PA_plot_weighted + theme(plot.margin = unit(c(2,2,2,2), "lines")), DNA_PA_plot_weighted + theme(plot.margin = unit(c(2,2,2,2), "lines")), RNA_FL_plot_weighted + theme(plot.margin = unit(c(2,2,2,2), "lines")), DNA_FL_plot_weighted + theme(plot.margin = unit(c(2,2,2,2), "lines")), labels = c('A) RNA PA', 'B) DNA PA', 'C) RNA FL', 'D) DNA FL'), label_size = 12)
weigthed_legend <- plot_grid(weigthed_no_legend, legend, ncol=2, rel_widths = c(4, 1))
weigthed_legend <- plot_grid(title_gg_weighted, weigthed_legend, ncol=1, rel_heights=c(0.1, 1), aligh = "h")
weigthed_legend

```

Weighted UniFrac as distance method separated samples better then unweighted UniFrac.
Lets focus on this approach.
For FL DNA samples provided more defined clusters but for PA RNA data distinguished conditions better.
### 3.3.1 Distances between conditions in all groups

```{r}
library(dendextend)
hclust_avg <- hclust(weighted_unifrac_dist_first_day_PA_DNA_first_run, method = 'ward.D2')
hclust_avg <- as.dendrogram(hclust_avg)
plot(hclust_avg)
labels(hclust_avg)
sample_first_day_PA_DNA_first_run <- sample_first_day_PA_DNA_first_run[match(labels(hclust_avg), row.names(sample_first_day_PA_DNA_first_run)),]
labels_colors(hclust_avg) <-  as.numeric(sample_first_day_PA_DNA_first_run$source)
# Now each state has a color
labels_colors(hclust_avg) 
legend("topleft", legend = levels(sample_first_day_PA_DNA_first_run$source), fill = 1:4)
```

```{r}
manovaFL <- manova(data=data.frame(p$data), formula = cbind(Axis.1, Axis.2) ~ temperature_elevation*DNA_or_RNA)
summary(manovaFL)        # Pillai's trace, Wilks' Lambda, etc.
summary.aov(manovaFL)    #
aov_pc1 <- aov(Axis.1 ~ temperature_elevation*DNA_or_RNA, data = p$data)
TukeyHSD(aov_pc1)
aov_pc2 <- aov(Axis.2 ~ temperature_elevation*DNA_or_RNA, data = p$data)
TukeyHSD(aov_pc2)
#PA

manovaPA <- manova(data=data.frame(p$data), formula = cbind(Axis.1, Axis.2) ~ temperature_elevation*DNA_or_RNA)
summary(manovaPA)        # Pillai's trace, Wilks' Lambda, etc.
summary.aov(manovaPA)    #
aov_pc1 <- aov(Axis.1 ~ temperature_elevation*DNA_or_RNA, data = p$data)
TukeyHSD(aov_pc1)
aov_pc2 <- aov(Axis.2 ~ temperature_elevation*DNA_or_RNA, data = p$data)
TukeyHSD(aov_pc2)
anosim_fraction <- anosim(IP_drep[which(!is.na(IP_drep$Fraction_niche)), "IP" ], Fraction_niche, permutations = 999, distance = "bray", strata = NULL)

#check anosim and adonis on such distance matrixes 
#PA DNA

weighted_unifrac_dist_first_day_PA_DNA_first_run
sample_first_day_PA_DNA_first_run <-
#the sample 97 probably did not work out [ remove from the metadata 
sample_first_day_PA_DNA_first_run <- sample_first_day_PA_DNA_first_run[which(row.names(sample_first_day_PA_DNA_first_run)!="JG_97D"),]
attach(sample_first_day_PA_DNA_first_run)
PA_DNA.ano <- anosim(weighted_unifrac_dist_first_day_PA_DNA_first_run, source)
#repeat for DNA FL
#check labels 
keep <- which(row.names(sample_first_day_FL_DNA_first_run) %in% labels(weighted_unifrac_dist_first_day_FL_DNA_first_run)) 
sample_first_day_FL_DNA_first_run <- sample_first_day_FL_DNA_first_run[keep,]
attach(sample_first_day_FL_DNA_first_run)
FL_DNA.ano <- anosim(weighted_unifrac_dist_first_day_FL_DNA_first_run, source)
#PA RNA
keep <- which(labels(weighted_unifrac_dist_first_day_PA_RNA_first_run) %in% row.names(sample_first_day_PA_RNA_first_run))

#the sample 97 probably did not work out [ remove from the metadata 
sample_first_day_PA_RNA_first_run <- sample_first_day_PA_RNA_first_run[keep,]
attach(sample_first_day_PA_RNA_first_run)
PA_RNA.ano <- anosim(weighted_unifrac_dist_first_day_PA_RNA_first_run, source)
#repeat for RNA FL
keep <- which(labels(weighted_unifrac_dist_first_day_FL_RNA_first_run) %in% row.names(sample_first_day_FL_RNA_first_run))

#the sample 97 probably did not work out [ remove from the metadata 
sample_first_day_FL_RNA_first_run <- sample_first_day_FL_RNA_first_run[keep,]
attach(sample_first_day_FL_RNA_first_run)
FL_RNA.ano <- anosim(weighted_unifrac_dist_first_day_FL_RNA_first_run, source)
#no significant ifferences

#check labels 
keep <- which(row.names(sample_first_day_FL_DNA_first_run) %in% labels(weighted_unifrac_dist_first_day_FL_DNA_first_run)) 
sample_first_day_FL_DNA_first_run <- sample_first_day_FL_DNA_first_run[keep,]
attach(sample_first_day_FL_DNA_first_run)
PA_DNA.ano <- anosim(weighted_unifrac_dist_first_day_FL_DNA_first_run, source)```
```{r}
library(vegan)

data(dune)
data(dune.env)
dune.dist <- vegdist(dune)
attach(dune.env)
dune.ano <- anosim(dune.dist, Management)
summary(dune.ano)
plot(dune.ano)
```
### 3.3.2 Variance analysis between conditions in all groups

For FL fraction field samples seems to have similar distance between all experimental conditions.

```{r}
hclust_avg <- hclust(weighted_unifrac_dist_first_day_FL_DNA_first_run, method = 'ward.D2')
hclust_avg <- as.dendrogram(hclust_avg)
plot(hclust_avg)
labels(hclust_avg)
sample_first_day_PA_DNA_first_run <- sample_first_day_FL_DNA_first_run[match(labels(hclust_avg), row.names(sample_first_day_FL_DNA_first_run)),]
labels_colors(hclust_avg) <-  as.numeric(sample_first_day_FL_DNA_first_run$source)
# Now each state has a color
labels_colors(hclust_avg) 
legend("topleft", legend = levels(as.factor(sample_first_day_FL_DNA_first_run$source)), fill = 1:4)
```

For FL fraction field samples seems to have similar distance between all experimental conditions.

```{r}
hclust_avg <- hclust(weighted_unifrac_dist_first_day_PA_RNA_first_run, method = 'ward.D2')
hclust_avg <- as.dendrogram(hclust_avg)
plot(hclust_avg)
labels(hclust_avg)
sample_first_day_PA_RNA_first_run <- sample_first_day_PA_RNA_first_run[match(labels(hclust_avg), row.names(sample_first_day_PA_RNA_first_run)),]
labels_colors(hclust_avg) <-  as.numeric(as.factor(sample_first_day_PA_RNA_first_run$source))
# Now each state has a color
labels_colors(hclust_avg) 
legend("topleft", legend = levels(as.factor(sample_first_day_PA_RNA_first_run$source)), fill = 1:4)
```

For FL fraction field samples seems to have similar distance between all experimental conditions.

For PA fraction in RNA samples field samples seems to have similar distance between all experimental conditions.

```{r}
hclust_avg <- hclust(weighted_unifrac_dist_first_day_FL_RNA_first_run, method = 'ward.D2')
hclust_avg <- as.dendrogram(hclust_avg)
plot(hclust_avg)
labels(hclust_avg)
sample_first_day_PA_DNA_first_run <- sample_first_day_FL_RNA_first_run[match(labels(hclust_avg), row.names(sample_first_day_FL_RNA_first_run)),]
labels_colors(hclust_avg) <-  as.numeric(sample_first_day_FL_RNA_first_run$source)
# Now each state has a color
labels_colors(hclust_avg) 
legend("topleft", legend = levels(sample_first_day_FL_RNA_first_run$source), fill = 1:4)
```

# 5.Taxonomic overview

## 5.1 Taxonomic overview DNA vs RNA How is there and who is active?

```{r}
library(RColorBrewer)
colours <- rep(brewer.pal(n = 8, name = "Dark2"),10 )
taxa_level7 <- read.table("level-7.csv", header=T,
                        check.names=F, sep=",", row.names = 1) 

taxa_level7_long <- taxa_level7 %>%
  pivot_longer(!colnames(taxa_level7)[43:52], names_to = "taxa", values_to = "count") %>% filter(count>0) %>% separate( col=taxa, sep = ";", into=c("level_1", "level_2", "level_3", "level_4", "level_5", "level_6", "level_7")) #split taxa column into multiple by ";"

taxa_level7_long_DNA <- taxa_level7_long[which(taxa_level7_long$`DNA or RNA`=="DNA" & taxa_level7_long$type=="Water"), ]
taxa_level7_long_DNA <-  taxa_level7_long_DNA %>% mutate(alias= paste( fraction, `temperature elevation`, `sample nr`,sep = '_'))
DNA_taxa<- ggplot(data=taxa_level7_long_DNA, aes(x=alias, y=count, fill=taxa)) +
  geom_bar(position="fill", stat="identity") + guides(fill=guide_legend(ncol=1)) + scale_fill_manual(values = colours) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
#repeat for level 3
taxa_level3 <- read.table("level-3.csv", header=T,
                          check.names=F, sep=",", row.names = 1)
taxa_level3_long <- taxa_level3 %>%
  pivot_longer(!colnames(taxa_level3)[17:26], names_to = "taxa", values_to = "count") %>% filter(count>0)
taxa_level3_long_DNA <- taxa_level3_long[which(taxa_level3_long$`DNA or RNA`=="DNA" & taxa_level3_long$type=="Water"), ]
taxa_level3_long_DNA <-  taxa_level3_long_DNA %>% mutate(alias= paste( fraction, `temperature elevation`, `sample nr`, `sampling date`), sep = '_')

DNA_taxa<- ggplot(data=taxa_level3_long_DNA, aes(x=alias, y=count, fill=taxa)) +
  geom_bar(position="fill", stat="identity") + guides(fill=guide_legend(ncol=1)) + scale_fill_manual(values = colours) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#comapre with RNA
taxa_level3_long_RNA <- taxa_level3_long[which(taxa_level3_long$`DNA or RNA`=="RNA" & taxa_level3_long$type=="Water"), ]
taxa_level3_long_RNA <-  taxa_level3_long_RNA %>% mutate(alias= paste( fraction, `temperature elevation`, `sample nr`, `sampling date`), sep = '_')
RNA_taxa<- ggplot(data=taxa_level3_long_RNA, aes(x=alias, y=count, fill=taxa)) +
  geom_bar(position="fill", stat="identity") + guides(fill=guide_legend(ncol=1)) + scale_fill_manual(values = colours) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
#facet RNA and dna
#comapre with RNA
taxa_level3_long <- taxa_level3_long[which(taxa_level3_long$type=="Water" & (taxa_level3_long$`sampling date`=="29/07/2024" | taxa_level3_long$`sampling date`=="31/07/2024" )),]
taxa_level3_long <-  taxa_level3_long %>% mutate(alias= paste( fraction, `temperature elevation`, `sample nr`, `tank or field`), sep = '_')
taxa <- ggplot(data=taxa_level3_long, aes(x=alias, y=count, fill=taxa)) +
  geom_bar(position="fill", stat="identity") + guides(fill=guide_legend(ncol=1)) + scale_fill_manual(values = colours) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + facet_grid(rows = vars(`DNA or RNA`), cols=vars(fraction), scales="free")
taxa
```

## 5.2 Taxonomic comparison bewtween sediment and corresponding DNA samples.

Did organism migrated to the sediment?
Are they active or dormant?

```{r}
taxa_level3_long <- taxa_level3 %>%
  pivot_longer(!colnames(taxa_level3)[17:26], names_to = "taxa", values_to = "count") %>% filter(count>0)
taxa_level3_long_sed <- taxa_level3_long[which(taxa_level3_long$`type`=="Sediment"),]
taxa_level3_long_sed <- taxa_level3_long_sed %>% mutate(alias= paste( fraction, `temperature elevation`, `sample nr`), sep = '_')
taxa_sed <- ggplot(data=taxa_level3_long_sed, aes(x=alias, y=count, fill=taxa)) +
  geom_bar(position="fill", stat="identity") + guides(fill=guide_legend(ncol=1)) + scale_fill_manual(values = colours) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + facet_grid(rows = vars(`DNA or RNA`))

taxa_level3_long_sed_vs_water <- taxa_level3_long[which(taxa_level3_long$`sampling date`=="23/08/2024" | taxa_level3_long$`sampling date`=="21/08/2024" ),]
taxa_level3_long_sed_vs_water <-  taxa_level3_long_sed_vs_water %>% mutate(alias= paste(fraction, `temperature elevation`, `sample nr`, `DNA or RNA`), sep = '_')
#repair mistake in metadata
taxa_level3_long_sed_vs_water$sampling_site[which(taxa_level3_long_sed_vs_water$sampling_site=="1B")] <-"1C"
taxa_level3_long_sed_vs_water$sampling_site[which(taxa_level3_long_sed_vs_water$sampling_site=="3J")] <-"3I"

taxa_sed_vs_water <- ggplot(data=taxa_level3_long_sed_vs_water, aes(x=sampling_site, y=count, fill=taxa)) +
  geom_bar(position="fill", stat="identity") + guides(fill=guide_legend(ncol=1)) + scale_fill_manual(values = colours) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + facet_grid(rows = vars(`type`), cols = vars(`DNA or RNA`))
taxa_sed_vs_water
```

In water there are more identified samples.

Check correlation between distance matrixes of corresponding DNA and RNA samples by mantel test to see if differences in RNA are driven by differences in abundances or in expression.

```{r}
#dist of temp 

# list.PA.dists <- list(weighted_unifrac_dist_first_day_PA_DNA_first_run, weighted_unifrac_dist_first_day_PA_RNA_first_run, 
#                         unweighted_unifrac_dist_first_day_PA_DNA_first_run, unweighted_unifrac_dist_first_day_PA_RNA_first_run)
# 
# list.FL.dists <- list(weighted_unifrac_dist_first_day_FL_DNA_first_run, weighted_unifrac_dist_first_day_FL_RNA_first_run, 
#                         unweighted_unifrac_dist_first_day_FL_DNA_first_run, unweighted_unifrac_dist_first_day_FL_RNA_first_run)
# res_mantel_sig <- matrix(nrow=2, ncol=4, dimnames = list(c("PA", "FL"), c("weighted Unifrac DNA", "weighted Unifrac RNA" , "unweighted Unifrac DNA", "unweighted Unifrac RNA" )))
# res_mantel_R <- matrix(nrow=2, ncol=4, dimnames = list(c("PA", "FL"), c("weighted Unifrac DNA", "weighted Unifrac RNA" , "unweighted Unifrac DNA", "unweighted Unifrac RNA" )))

res_PA_weight <- mantel(weighted_unifrac_dist_first_day_PA_DNA_first_run, weighted_unifrac_dist_first_day_PA_RNA_first_run, method = "spearman", permutations = 9999, na.rm = TRUE)
res_PA_unweight <- mantel(unweighted_unifrac_dist_first_day_PA_DNA_first_run, unweighted_unifrac_dist_first_day_PA_RNA_first_run, method = "spearman", permutations = 9999, na.rm = TRUE)

res_FL_weight <- mantel(weighted_unifrac_dist_first_day_FL_DNA_first_run, weighted_unifrac_dist_first_day_FL_RNA_first_run, method = "spearman", permutations = 9999, na.rm = TRUE)
res_FL_unweight <- mantel(unweighted_unifrac_dist_first_day_FL_DNA_first_run, unweighted_unifrac_dist_first_day_FL_RNA_first_run, method = "spearman", permutations = 9999, na.rm = TRUE)
```

The values from unweighted Unifrac have low R statistic and comparable high p-value.
Lets take into account only weighted Unifrac.
For Particulate fraction the R value is `r toString(res_PA_weight$statistic)` with `r toString(res_PA_weight$statistic)` \< 0.001.
For free-living fraction `r toString(res_FL_weight$statistic)` with `r  toString(res_FL_weight$statistic)` \< 0.001.
These result suggest that expression partially drives the differences between RNA and DNA samples.
